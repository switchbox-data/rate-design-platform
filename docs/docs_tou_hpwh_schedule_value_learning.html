<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Switchbox">
<meta name="dcterms.date" content="2025-07-22">

<title>Value-Learning TOU Scheduling Decision Model for HPWHs in OCHRE</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */
  vertical-align: middle;
}
</style>


<script src="docs_tou_hpwh_schedule_value_learning_files/libs/clipboard/clipboard.min.js"></script>
<script src="docs_tou_hpwh_schedule_value_learning_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="docs_tou_hpwh_schedule_value_learning_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="docs_tou_hpwh_schedule_value_learning_files/libs/quarto-html/popper.min.js"></script>
<script src="docs_tou_hpwh_schedule_value_learning_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="docs_tou_hpwh_schedule_value_learning_files/libs/quarto-html/anchor.min.js"></script>
<link href="docs_tou_hpwh_schedule_value_learning_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="docs_tou_hpwh_schedule_value_learning_files/libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="docs_tou_hpwh_schedule_value_learning_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="docs_tou_hpwh_schedule_value_learning_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="docs_tou_hpwh_schedule_value_learning_files/libs/bootstrap/bootstrap-81267100e462c21b3d6c0d5bf76a3417.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="docs_tou_hpwh_schedule_value_learning_files/libs/quarto-diagram/mermaid.min.js"></script>
<script src="docs_tou_hpwh_schedule_value_learning_files/libs/quarto-diagram/mermaid-init.js"></script>
<link href="docs_tou_hpwh_schedule_value_learning_files/libs/quarto-diagram/mermaid.css" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="docs_tou_hpwh_schedule_value_learning.md"><i class="bi bi-file-code"></i>Github (GFM)</a></li></ul></div></div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Value-Learning TOU Scheduling Decision Model for HPWHs in OCHRE</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Switchbox </p>
          </div>
  </div>

    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">July 22, 2025</p>
    </div>
  </div>


  </div>



</header>


<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>This document outlines a value-learning decision model for consumer response to time-of-use (TOU) electricity rates in residential building simulations using OCHRE, focusing on Heat Pump Water Heaters (HPWHs). The goal is to model how consumers learn about schedule performance through direct experience, using exploration and exploitation strategies to optimize their electricity costs while accounting for comfort trade-offs.</p>
</section>
<section id="problem-definition" class="level1">
<h1>1. Problem Definition</h1>
<p>This section establishes a high-level overview of the core research question and modeling assumptions for consumer learning about TOU schedule performance.</p>
<p><strong>Objective:</strong></p>
<p>Model how consumers learn about TOU-friendly HPWH scheduling through direct experience, using exploration and exploitation strategies to balance trying new approaches with using learned knowledge to minimize electricity costs and comfort penalties.</p>
<p><strong>Assumptions:</strong></p>
<ul>
<li><p>Hot water usage schedule is fixed (not flexible) and set by inputs to the model.</p></li>
<li><p>HPWH can be controlled (on/off) on a schedule.</p></li>
<li><p>Consumer is already on TOU rates (given) and must choose between default and TOU-friendly HPWH operation schedules.</p></li>
<li><p>Consumers learn schedule performance through direct experience rather than external information sources.</p></li>
<li><p>Decision-making occurs at monthly bill receipt based on learned values for each schedule option.</p></li>
<li><p>Exploration propensity varies by household characteristics (income, building age, household size, water heater type).</p></li>
<li><p>Learning speed varies by household characteristics affecting information processing ability.</p></li>
<li><p>Consumers track total costs (bills + comfort impacts) for each schedule and use this learned knowledge to make decisions.</p></li>
</ul>
</section>
<section id="key-variables-and-parameters" class="level1">
<h1>2. Key Variables and Parameters</h1>
<p>This section defines all variables, parameters, and their temporal dimensions used throughout the value-learning decision model.</p>
<table class="caption-top table">
<colgroup>
<col style="width: 16%">
<col style="width: 6%">
<col style="width: 56%">
<col style="width: 10%">
<col style="width: 11%">
</colgroup>
<thead>
<tr class="header">
<th>Symbol</th>
<th>Type</th>
<th>Description</th>
<th>Units</th>
<th>Dimension</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Sets</strong></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td><span class="math inline">\(M\)</span></td>
<td>Set</td>
<td>Months in simulation year, <span class="math inline">\(m \in \{1, 2, ..., 12\}\)</span></td>
<td>-</td>
<td>12 × 1</td>
</tr>
<tr class="odd">
<td><span class="math inline">\(T\)</span></td>
<td>Set</td>
<td>Time periods in billing month, <span class="math inline">\(t \in \{1, 2, ..., T\}\)</span> where <span class="math inline">\(T \approx 2976\)</span> (15-min intervals)</td>
<td>-</td>
<td>|T| × 1</td>
</tr>
<tr class="even">
<td><span class="math inline">\(H\)</span></td>
<td>Set</td>
<td>Peak hour periods, <span class="math inline">\(H \subset T\)</span></td>
<td>-</td>
<td>|H| × 1</td>
</tr>
<tr class="odd">
<td><strong>Parameters</strong></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td><span class="math inline">\(U_{m,t}^{HW}\)</span></td>
<td>Parameter</td>
<td>Exogenous hot water usage schedule at time <span class="math inline">\(t\)</span> in month <span class="math inline">\(m\)</span></td>
<td>L/15min</td>
<td>M × T</td>
</tr>
<tr class="odd">
<td><span class="math inline">\(r^{on}\)</span></td>
<td>Parameter</td>
<td>TOU electricity rate during peak hours</td>
<td>$/kWh</td>
<td>1 × 1</td>
</tr>
<tr class="even">
<td><span class="math inline">\(r^{off}\)</span></td>
<td>Parameter</td>
<td>TOU electricity rate during off-peak hours</td>
<td>$/kWh</td>
<td>1 × 1</td>
</tr>
<tr class="odd">
<td><span class="math inline">\(\alpha\)</span></td>
<td>Parameter</td>
<td>Monetization factor for comfort penalty (building-specific)</td>
<td>$/kWh</td>
<td>1 × 1</td>
</tr>
<tr class="even">
<td><span class="math inline">\(T_{m,t}^{setpoint}\)</span></td>
<td>Parameter</td>
<td>Hot water temperature setpoint at time <span class="math inline">\(t\)</span> in month <span class="math inline">\(m\)</span></td>
<td>°C</td>
<td>M × T</td>
</tr>
<tr class="odd">
<td><span class="math inline">\(T_{m,t}^{ambient}\)</span></td>
<td>Parameter</td>
<td>Ambient water temperature at time <span class="math inline">\(t\)</span> in month <span class="math inline">\(m\)</span></td>
<td>°C</td>
<td>M × T</td>
</tr>
<tr class="even">
<td><span class="math inline">\(\rho\)</span></td>
<td>Parameter</td>
<td>Water density</td>
<td>kg/L</td>
<td>1 × 1</td>
</tr>
<tr class="odd">
<td><span class="math inline">\(c_p\)</span></td>
<td>Parameter</td>
<td>Specific heat of water</td>
<td>J/kg·°C</td>
<td>1 × 1</td>
</tr>
<tr class="even">
<td><span class="math inline">\(COP\)</span></td>
<td>Parameter</td>
<td>Heat pump coefficient of performance</td>
<td>-</td>
<td>1 × 1</td>
</tr>
<tr class="odd">
<td><strong>Learning Parameters</strong></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td><span class="math inline">\(\epsilon_{base}\)</span></td>
<td>Parameter</td>
<td>Base exploration rate</td>
<td>-</td>
<td>1 × 1</td>
</tr>
<tr class="odd">
<td><span class="math inline">\(\alpha_{base}^{learn}\)</span></td>
<td>Parameter</td>
<td>Base learning rate</td>
<td>-</td>
<td>1 × 1</td>
</tr>
<tr class="even">
<td><strong>Decision Variables</strong></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td><span class="math inline">\(x_m^{switch}\)</span></td>
<td>Binary</td>
<td>Decision to switch schedule in month <span class="math inline">\(m\)</span> (1 = switch, 0 = stay)</td>
<td>binary</td>
<td>M × 1</td>
</tr>
<tr class="even">
<td><strong>State Variables</strong></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td><span class="math inline">\(S_m^{current}\)</span></td>
<td>Binary</td>
<td>Current schedule state in month <span class="math inline">\(m\)</span> (1 = default, 0 = TOU-adapted)</td>
<td>binary</td>
<td>M × 1</td>
</tr>
<tr class="even">
<td><span class="math inline">\(s_{m,t}\)</span></td>
<td>Binary</td>
<td>HPWH operation permission at time <span class="math inline">\(t\)</span> in month <span class="math inline">\(m\)</span> (1 = allowed, 0 = restricted)</td>
<td>binary</td>
<td>M × T</td>
</tr>
<tr class="odd">
<td><span class="math inline">\(r_{m,t}\)</span></td>
<td>Variable</td>
<td>Electricity rate at time <span class="math inline">\(t\)</span> in month <span class="math inline">\(m\)</span> (determined by peak/off-peak)</td>
<td>$/kWh</td>
<td>M × T</td>
</tr>
<tr class="even">
<td><span class="math inline">\(E_{m,t}\)</span></td>
<td>Variable</td>
<td>Electricity consumption from HPWH operation at time <span class="math inline">\(t\)</span> in month <span class="math inline">\(m\)</span></td>
<td>kWh/15min</td>
<td>M × T</td>
</tr>
<tr class="odd">
<td><span class="math inline">\(T_{m,t}^{tank}\)</span></td>
<td>Variable</td>
<td>Tank water temperature at time <span class="math inline">\(t\)</span> in month <span class="math inline">\(m\)</span></td>
<td>°C</td>
<td>M × T</td>
</tr>
<tr class="even">
<td><span class="math inline">\(Q_{m,t}^{unmet}\)</span></td>
<td>Variable</td>
<td>Thermal unmet demand at time <span class="math inline">\(t\)</span> in month <span class="math inline">\(m\)</span></td>
<td>J/15min</td>
<td>M × T</td>
</tr>
<tr class="odd">
<td><span class="math inline">\(D_{m,t}^{unmet}\)</span></td>
<td>Variable</td>
<td>Electrical equivalent unmet demand at time <span class="math inline">\(t\)</span> in month <span class="math inline">\(m\)</span></td>
<td>kWh/15min</td>
<td>M × T</td>
</tr>
<tr class="even">
<td><strong>Derived Variables</strong></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td><span class="math inline">\(C_m^{bill}\)</span></td>
<td>Variable</td>
<td>Monthly electricity bill for water heating in month <span class="math inline">\(m\)</span></td>
<td>$</td>
<td>M × 1</td>
</tr>
<tr class="even">
<td><span class="math inline">\(C_m^{comfort}\)</span></td>
<td>Variable</td>
<td>Monthly comfort penalty from unmet demand in month <span class="math inline">\(m\)</span></td>
<td>$</td>
<td>M × 1</td>
</tr>
<tr class="odd">
<td><strong>Value Learning State Variables</strong></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td><span class="math inline">\(V_m^{default}\)</span></td>
<td>Variable</td>
<td>Learned value (total cost) for default schedule</td>
<td>$</td>
<td>M × 1</td>
</tr>
<tr class="odd">
<td><span class="math inline">\(V_m^{TOU}\)</span></td>
<td>Variable</td>
<td>Learned value (total cost) for TOU schedule</td>
<td>$</td>
<td>M × 1</td>
</tr>
<tr class="even">
<td><span class="math inline">\(\epsilon_m\)</span></td>
<td>Variable</td>
<td>Household-specific exploration rate in month <span class="math inline">\(m\)</span></td>
<td>-</td>
<td>M × 1</td>
</tr>
<tr class="odd">
<td><span class="math inline">\(\alpha_m^{learn}\)</span></td>
<td>Variable</td>
<td>Household-specific learning rate in month <span class="math inline">\(m\)</span></td>
<td>-</td>
<td>M × 1</td>
</tr>
</tbody>
</table>
<section id="building-specific-parameter-formulations" class="level2">
<h2 class="anchored" data-anchor-id="building-specific-parameter-formulations">2.1 Building-Specific Parameter Formulations</h2>
<p>The exploration and learning rates are derived from building and household characteristics available in ResStock/OCHRE simulations to reflect realistic heterogeneity in consumer behavior.</p>
<section id="exploration-rate-parameters" class="level3">
<h3 class="anchored" data-anchor-id="exploration-rate-parameters">Exploration Rate Parameters</h3>
<p><strong>Household-Specific Exploration Rate (<span class="math inline">\(\epsilon_m\)</span>):</strong></p>
<p>The propensity to explore new scheduling strategies varies with household characteristics that affect willingness to experiment and tolerance for uncertainty.</p>
<p><span class="math display">\[
\epsilon_m = \epsilon_{base} \times f_{AMI} \times \frac{1}{f_{age}} \times \frac{1}{f_{residents}} \times f_{WH}
\]</span></p>
<p>Where:</p>
<ul>
<li><p><span class="math inline">\(\epsilon_{base}\)</span> = base exploration rate for average household (to be calibrated)</p></li>
<li><p><span class="math inline">\(f_{AMI} = \sqrt{\frac{AMI}{80\%}}\)</span> (income factor: higher income increases willingness to experiment due to reduced financial stress)</p></li>
<li><p><span class="math inline">\(f_{age} = 1.0 + 0.005 \times \max(0, 2000 - YearBuilt)\)</span> (building age proxy: newer buildings correlate with tech-savvy households more willing to try new strategies)</p></li>
<li><p><span class="math inline">\(f_{residents} = 1.0 + 0.1 \times \ln(N_{residents})\)</span> (coordination complexity: fewer residents make it easier to experiment with new schedules)</p></li>
<li><p><span class="math inline">\(f_{WH} = \{0.7 \text{ (heat pump)}, 1.0 \text{ (storage)}, 1.5 \text{ (tankless)}\}\)</span> (water heater type: heat pumps have smart controls enabling easier experimentation, tankless units are harder to schedule)</p></li>
</ul>
</section>
<section id="learning-rate-parameters" class="level3">
<h3 class="anchored" data-anchor-id="learning-rate-parameters">Learning Rate Parameters</h3>
<p><strong>Household-Specific Learning Rate (<span class="math inline">\(\alpha_m^{learn}\)</span>):</strong></p>
<p>The speed at which households update their beliefs about schedule performance varies with characteristics that affect information processing and attention to energy costs.</p>
<p><span class="math display">\[
\alpha_m^{learn} = \alpha_{base}^{learn} \times g_{AMI} \times \frac{1}{f_{age}}
\]</span></p>
<p>Where:</p>
<ul>
<li><p><span class="math inline">\(\alpha_{base}^{learn}\)</span> = base learning rate for average household (to be calibrated)</p></li>
<li><p><span class="math inline">\(g_{AMI} = (\frac{AMI}{80\%})^{0.6}\)</span> (income factor: higher income households process bill information faster due to education/resources)</p></li>
<li><p><span class="math inline">\(\frac{1}{f_{age}}\)</span> = faster learning in newer buildings (proxy for tech-savvy households better at interpreting energy feedback)</p></li>
</ul>
</section>
<section id="comfort-monetization-factor" class="level3">
<h3 class="anchored" data-anchor-id="comfort-monetization-factor">Comfort Monetization Factor</h3>
<p><strong>Comfort Penalty Monetization (<span class="math inline">\(\alpha\)</span>):</strong></p>
<p>The monetization factor represents how much households value avoiding unmet hot water demand and varies with income, household size, and climate sensitivity.</p>
<p><span class="math display">\[
\alpha = \alpha_{base} \times g_{AMI} \times g_{residents} \times g_{climate}
\]</span></p>
<p>Where:</p>
<ul>
<li><p><span class="math inline">\(\alpha_{base}\)</span> = base comfort value for average household (to be calibrated)</p></li>
<li><p><span class="math inline">\(g_{AMI} = (\frac{AMI}{80\%})^{0.6}\)</span> (income factor: power function &lt;1 reflects decreasing marginal utility of income)</p></li>
<li><p><span class="math inline">\(g_{residents} = 1.0 + 0.2 \times (N_{residents} - 1)\)</span> (household size effect: each additional person increases conflict probability over hot water usage)</p></li>
<li><p><span class="math inline">\(g_{climate} = \{0.8 \text{ (zones 1-3)}, 1.0 \text{ (zones 4-5)}, 1.2 \text{ (zones 6-8)}\}\)</span> (climate zone factor: colder climates increase hot water importance)</p></li>
</ul>
<p><strong>Example:</strong> For a mid-income family (80% AMI, 3 residents, 1980 building, storage water heater, zone 4): - <span class="math inline">\(\epsilon_m = \epsilon_{base} \times 1.0 \times \frac{1}{1.1} \times \frac{1}{1.11} \times 1.0 = 0.81\epsilon_{base}\)</span> - <span class="math inline">\(\alpha_m^{learn} = \alpha_{base}^{learn} \times 1.0 \times \frac{1}{1.1} = 0.91\alpha_{base}^{learn}\)</span> - <span class="math inline">\(\alpha = \alpha_{base} \times 1.0 \times 1.4 \times 1.0 = 1.4\alpha_{base}\)</span></p>
</section>
</section>
</section>
<section id="detailed-model-steps" class="level1">
<h1>3. Detailed Model Steps</h1>
<p>This section outlines the complete sequential decision-making process that consumers follow each month through exploration, exploitation, and value learning based on direct experience.</p>
<section id="step-1-initialize-monthly-state-variables" class="level2">
<h2 class="anchored" data-anchor-id="step-1-initialize-monthly-state-variables">Step 1: Initialize Monthly State Variables</h2>
<p>This step loads the exogenous input data and sets the initial state variables for month <span class="math inline">\(m\)</span>’s simulation. The hot water usage profile <span class="math inline">\(U_{m,t}^{HW}\)</span> defines when and how much hot water is demanded throughout the month’s 2976 time periods. Temperature setpoints <span class="math inline">\(T_{m,t}^{setpoint}\)</span> and ambient conditions <span class="math inline">\(T_{m,t}^{ambient}\)</span> establish the thermal boundary conditions for month <span class="math inline">\(m\)</span>. The electricity rate vector <span class="math inline">\(r_{m,t}\)</span> is constructed by mapping peak hours set <span class="math inline">\(H\)</span> to the on-peak rate <span class="math inline">\(r^{on}\)</span> and all other periods to off-peak rate <span class="math inline">\(r^{off}\)</span>.</p>
<p><strong>Set Time-Varying Parameters for Month <span class="math inline">\(m\)</span>:</strong></p>
<ul>
<li><p>Load hot water usage schedule: <span class="math inline">\(U_{m,t}^{HW}\)</span> for all <span class="math inline">\(t \in T\)</span></p></li>
<li><p>Load temperature profiles: <span class="math inline">\(T_{m,t}^{setpoint}\)</span>, <span class="math inline">\(T_{m,t}^{ambient}\)</span> for all <span class="math inline">\(t \in T\)</span></p></li>
<li><p>Set electricity rates: <span class="math inline">\(r_{m,t} = r^{on}\)</span> if <span class="math inline">\(t \in H\)</span>, else <span class="math inline">\(r_{m,t} = r^{off}\)</span></p></li>
</ul>
<p><strong>Initialize Schedule State for Month <span class="math inline">\(m\)</span>:</strong></p>
<ul>
<li><p>If <span class="math inline">\(m = 1\)</span>: set <span class="math inline">\(S_m^{current} = 1\)</span> (start on default schedule)</p></li>
<li><p>Else: <span class="math inline">\(S_m^{current} = S_{m-1}^{current,next}\)</span> (use previous month’s decision outcome)</p></li>
</ul>
<p><strong>Initialize Value Learning State for Month <span class="math inline">\(m\)</span>:</strong></p>
<ul>
<li><p>If <span class="math inline">\(m = 1\)</span>: set <span class="math inline">\(V_m^{default} = V_m^{TOU} = 0\)</span> (no prior experience)</p></li>
<li><p>Else: <span class="math inline">\(V_m^{default} = V_{m-1}^{default}\)</span> and <span class="math inline">\(V_m^{TOU} = V_{m-1}^{TOU}\)</span> (carry forward learned values)</p></li>
</ul>
<p><strong>Set Operational Schedule for Month <span class="math inline">\(m\)</span>:</strong></p>
<p>The binary operation permission vector <span class="math inline">\(s_{m,t}\)</span> is derived from the current schedule state <span class="math inline">\(S_m^{current}\)</span>. When <span class="math inline">\(S_m^{current} = 1\)</span> (default), the HPWH can operate whenever needed (<span class="math inline">\(s_{m,t} = 1\)</span> for all <span class="math inline">\(t\)</span>). When <span class="math inline">\(S_m^{current} = 0\)</span> (TOU-adapted), operation is restricted during peak hours (<span class="math inline">\(s_{m,t} = 0\)</span> when <span class="math inline">\(t \in H\)</span>).</p>
<p><span class="math display">\[
s_{m,t} = \begin{cases}
1 &amp; \text{if } S_m^{current} = 1 \text{ (default: always allowed)} \\
1 &amp; \text{if } S_m^{current} = 0 \text{ and } t \notin H \text{ (TOU: off-peak only)} \\
0 &amp; \text{if } S_m^{current} = 0 \text{ and } t \in H \text{ (TOU: peak restricted)}
\end{cases}
\]</span></p>
</section>
<section id="step-2-run-ochre-simulation-for-month-m" class="level2">
<h2 class="anchored" data-anchor-id="step-2-run-ochre-simulation-for-month-m">Step 2: Run OCHRE Simulation for Month <span class="math inline">\(m\)</span></h2>
<p>OCHRE executes the building physics simulation for month <span class="math inline">\(m\)</span> using the operational schedule <span class="math inline">\(s_{m,t}\)</span> as a constraint on HPWH operation. For each 15-minute interval <span class="math inline">\(t\)</span> in month <span class="math inline">\(m\)</span>, OCHRE determines whether the HPWH can operate based on <span class="math inline">\(s_{m,t}\)</span>, then calculates the resulting electricity consumption <span class="math inline">\(E_{m,t}\)</span> and tank temperature <span class="math inline">\(T_{m,t}^{tank}\)</span> considering hot water draws <span class="math inline">\(U_{m,t}^{HW}\)</span>, thermal losses, and ambient conditions <span class="math inline">\(T_{m,t}^{ambient}\)</span>. The monthly electricity bill is computed by summing the product of consumption and time-varying rates across all time periods in month <span class="math inline">\(m\)</span>.</p>
<p><strong>Execute Monthly Simulation for Month <span class="math inline">\(m\)</span>:</strong></p>
<ul>
<li><p>Input: <span class="math inline">\(U_{m,t}^{HW}\)</span>, <span class="math inline">\(s_{m,t}\)</span>, <span class="math inline">\(T_{m,t}^{setpoint}\)</span>, <span class="math inline">\(T_{m,t}^{ambient}\)</span> for all <span class="math inline">\(t \in T\)</span></p></li>
<li><p>Output: <span class="math inline">\(E_{m,t}\)</span>, <span class="math inline">\(T_{m,t}^{tank}\)</span> for all <span class="math inline">\(t \in T\)</span></p></li>
</ul>
<p><strong>Calculate Monthly Electricity Bill for Month <span class="math inline">\(m\)</span>:</strong></p>
<p><span class="math display">\[
C_m^{bill} = \sum_{t \in T} E_{m,t} \cdot r_{m,t}
\]</span></p>
</section>
<section id="step-3-assess-comfort-performance-for-month-m" class="level2">
<h2 class="anchored" data-anchor-id="step-3-assess-comfort-performance-for-month-m">Step 3: Assess Comfort Performance for Month <span class="math inline">\(m\)</span></h2>
<p>Comfort assessment for month <span class="math inline">\(m\)</span> begins by identifying time periods where tank temperature <span class="math inline">\(T_{m,t}^{tank}\)</span> falls below the setpoint <span class="math inline">\(T_{m,t}^{setpoint}\)</span> during hot water usage events (<span class="math inline">\(U_{m,t}^{HW} &gt; 0\)</span>). For each such period, the thermal energy shortfall <span class="math inline">\(Q_{m,t}^{unmet}\)</span> is calculated as the energy required to heat the delivered water from tank temperature to setpoint temperature, using water density <span class="math inline">\(\rho\)</span> and specific heat <span class="math inline">\(c_p\)</span>. This thermal deficit is then converted to electrical energy equivalent <span class="math inline">\(D_{m,t}^{unmet}\)</span> by dividing by the heat pump’s coefficient of performance <span class="math inline">\(COP\)</span> and converting from Joules to kWh. The total comfort penalty for month <span class="math inline">\(m\)</span>, <span class="math inline">\(C_m^{comfort}\)</span>, monetizes these electrical energy equivalents using the comfort parameter <span class="math inline">\(\alpha\)</span>.</p>
<p><strong>Calculate Thermal Unmet Demand for Month <span class="math inline">\(m\)</span>:</strong></p>
<p><span class="math display">\[
Q_{m,t}^{\text{unmet}} = \begin{cases}
U_{m,t}^{\text{HW}} \cdot \rho \cdot c_p \cdot (T_{m,t}^{\text{setpoint}} - T_{m,t}^{\text{tank}}) &amp; \text{if } T_{m,t}^{\text{tank}} &lt; T_{m,t}^{\text{setpoint}} \text{ and } U_{m,t}^{\text{HW}} &gt; 0 \\
0 &amp; \text{otherwise}
\end{cases}
\]</span></p>
<p><strong>Convert to Electrical Equivalent for Month <span class="math inline">\(m\)</span>:</strong></p>
<p><span class="math display">\[
D_{m,t}^{unmet} = \frac{Q_{m,t}^{unmet}}{COP \cdot 3,600,000}
\]</span></p>
<p><strong>Calculate Monthly Comfort Penalty for Month <span class="math inline">\(m\)</span>:</strong></p>
<p><span class="math display">\[
C_m^{comfort} = \alpha \cdot \sum_{t \in T} D_{m,t}^{unmet}
\]</span></p>
</section>
<section id="step-4-value-learning-and-decision-logic-for-month-m" class="level2">
<h2 class="anchored" data-anchor-id="step-4-value-learning-and-decision-logic-for-month-m">Step 4: Value Learning and Decision Logic for Month <span class="math inline">\(m\)</span></h2>
<p>Consumers make decisions using an exploration-exploitation framework, where they either explore alternative schedules or exploit their learned knowledge about schedule performance. The decision process incorporates household-specific exploration and learning rates based on building characteristics.</p>
<p><strong>Calculate Total Cost for Month <span class="math inline">\(m\)</span>:</strong></p>
<p><span class="math display">\[
C_m^{total} = C_m^{bill} + C_m^{comfort}
\]</span></p>
<p><strong>Update Learned Values:</strong></p>
<p>Update the learned value for the schedule that was used in month <span class="math inline">\(m\)</span> using household-specific learning rate:</p>
<p><span class="math display">\[
V_m^{current} = (1 - \alpha_m^{learn}) \cdot V_{m-1}^{current} + \alpha_m^{learn} \cdot C_m^{total}
\]</span></p>
<p>Where <span class="math inline">\(V_m^{current} = V_m^{default}\)</span> if <span class="math inline">\(S_m^{current} = 1\)</span>, else <span class="math inline">\(V_m^{TOU}\)</span>.</p>
<p><strong>Generate Exploration Decision:</strong></p>
<p>Generate random number <span class="math inline">\(u \sim \mathcal{U}(0,1)\)</span> and compare to household-specific exploration rate:</p>
<p><span class="math display">\[
\text{Explore} = \begin{cases}
1 &amp; \text{if } u &lt; \epsilon_m \\
0 &amp; \text{otherwise}
\end{cases}
\]</span></p>
<p><strong>Make Switching Decision:</strong></p>
<p>The switching decision combines exploration and exploitation logic:</p>
<p><span class="math display">\[
x_m^{switch} = \begin{cases}
1 &amp; \text{if Explore = 1} \\
1 &amp; \text{if Explore = 0 and } V_m^{other} &lt; V_m^{current} \\
0 &amp; \text{otherwise}
\end{cases}
\]</span></p>
<p>Where <span class="math inline">\(V_m^{other}\)</span> is the learned value for the alternative schedule (if current schedule is default, then <span class="math inline">\(V_m^{other} = V_m^{TOU}\)</span>, and vice versa).</p>
</section>
<section id="step-5-update-state-for-next-month" class="level2">
<h2 class="anchored" data-anchor-id="step-5-update-state-for-next-month">Step 5: Update State for Next Month</h2>
<p>The schedule state <span class="math inline">\(S_{m+1}^{current}\)</span> for the next month is determined by the switching decision <span class="math inline">\(x_m^{switch}\)</span> made in month <span class="math inline">\(m\)</span>. If switching occurs (<span class="math inline">\(x_m^{switch} = 1\)</span>), the state toggles to its opposite value (<span class="math inline">\(1 - S_m^{current}\)</span>). If no switching occurs (<span class="math inline">\(x_m^{switch} = 0\)</span>), the state remains unchanged. Monthly results for month <span class="math inline">\(m\)</span> including <span class="math inline">\(C_m^{bill}\)</span>, <span class="math inline">\(C_m^{comfort}\)</span>, <span class="math inline">\(x_m^{switch}\)</span>, <span class="math inline">\(S_m^{current}\)</span>, and learned values are recorded for annual analysis.</p>
<p><strong>Update Schedule State for Month <span class="math inline">\(m+1\)</span>:</strong></p>
<p><span class="math display">\[
S_{m+1}^{current} = \begin{cases}
1 - S_m^{current} &amp; \text{if } x_m^{switch} = 1 \\
S_m^{current} &amp; \text{if } x_m^{switch} = 0
\end{cases}
\]</span></p>
<p><strong>Store Monthly Results for Month <span class="math inline">\(m\)</span>:</strong></p>
<ul>
<li><p>Record: <span class="math inline">\(C_m^{bill}\)</span>, <span class="math inline">\(C_m^{comfort}\)</span>, <span class="math inline">\(C_m^{total}\)</span>, <span class="math inline">\(x_m^{switch}\)</span>, <span class="math inline">\(S_m^{current}\)</span></p></li>
<li><p>Record: <span class="math inline">\(V_m^{default}\)</span>, <span class="math inline">\(V_m^{TOU}\)</span>, <span class="math inline">\(\epsilon_m\)</span>, <span class="math inline">\(\alpha_m^{learn}\)</span></p></li>
<li><p>Save for annual analysis and next month’s initialization</p></li>
</ul>
</section>
<section id="step-6-monthly-iteration-control" class="level2">
<h2 class="anchored" data-anchor-id="step-6-monthly-iteration-control">Step 6: Monthly Iteration Control</h2>
<p>The simulation checks whether the annual cycle is complete. If the current month <span class="math inline">\(m &lt; 12\)</span>, the month counter increments and the process returns to Step 1 with month <span class="math inline">\(m+1\)</span> and the updated schedule state <span class="math inline">\(S_{m+1}^{current}\)</span> and learned values. If month 12 is complete, the simulation proceeds to annual evaluation metrics calculation.</p>
<p><strong>Check Simulation Status:</strong></p>
<ul>
<li><p>If <span class="math inline">\(m &lt; 12\)</span>: increment to month <span class="math inline">\(m+1\)</span>, return to Step 1 with <span class="math inline">\(S_{m+1}^{current}\)</span>, <span class="math inline">\(V_{m+1}^{default}\)</span>, <span class="math inline">\(V_{m+1}^{TOU}\)</span></p></li>
<li><p>If <span class="math inline">\(m = 12\)</span>: proceed to annual evaluation (Step 7)</p></li>
</ul>
</section>
<section id="step-7-annual-evaluation-and-state-reset" class="level2">
<h2 class="anchored" data-anchor-id="step-7-annual-evaluation-and-state-reset">Step 7: Annual Evaluation and State Reset</h2>
<p>For multi-year simulations, the final month’s schedule state <span class="math inline">\(S_{13}^{current}\)</span> and learned values become the initial state for the following year’s first month, allowing persistence of consumer preferences and knowledge across years. Before resetting for the next annual cycle, comprehensive evaluation metrics are calculated and key visualizations are generated to assess model performance and consumer behavior patterns.</p>
<section id="step-7.1-calculate-annual-performance-metrics" class="level3">
<h3 class="anchored" data-anchor-id="step-7.1-calculate-annual-performance-metrics">Step 7.1: Calculate Annual Performance Metrics</h3>
<p><strong>Financial Performance:</strong></p>
<p><span class="math display">\[
\text{Total Annual Bill Costs} = \sum_{m=1}^{12} C_m^{bill}
\]</span></p>
<p><span class="math display">\[
\text{Total Annual Comfort Costs} = \sum_{m=1}^{12} C_m^{comfort}
\]</span></p>
<p><span class="math display">\[
\text{Total Annual Costs} = \sum_{m=1}^{12} C_m^{total}
\]</span></p>
<p><strong>Learning Metrics:</strong></p>
<p><span class="math display">\[
\text{Exploration Rate} = \frac{\sum_{m=1}^{12} x_m^{switch}}{12} \times 100\%
\]</span></p>
<p><span class="math display">\[
\text{Final Value Difference} = |V_{12}^{TOU} - V_{12}^{default}|
\]</span></p>
<p><span class="math display">\[
\text{TOU Adoption Rate} = \frac{\sum_{m=1}^{12} (1 - S_m^{current})}{12} \times 100\%
\]</span></p>
<p><strong>System Performance:</strong></p>
<p><span class="math display">\[
\text{Peak Load Reduction} = \frac{\sum_{m=1}^{12} \sum_{t \in H} (E_{m,t}^{baseline} - E_{m,t})}{\sum_{m=1}^{12} \sum_{t \in H} E_{m,t}^{baseline}} \times 100\%
\]</span></p>
</section>
<section id="step-7.2-generate-key-visualizations" class="level3">
<h3 class="anchored" data-anchor-id="step-7.2-generate-key-visualizations">Step 7.2: Generate Key Visualizations</h3>
<p><strong>A. Learning Trajectory</strong></p>
<ul>
<li><p>Line plot showing <span class="math inline">\(V_m^{default}\)</span> and <span class="math inline">\(V_m^{TOU}\)</span> over months with switching events marked</p></li>
<li><p>Purpose: Visualize learning process and convergence</p></li>
</ul>
<p><strong>B. Exploration vs Exploitation</strong></p>
<ul>
<li><p>Stacked bar chart showing exploration vs exploitation decisions by month</p></li>
<li><p>Purpose: Show balance between trying new strategies and using learned knowledge</p></li>
</ul>
<p><strong>C. Household Heterogeneity</strong></p>
<ul>
<li><p>Scatter plots of <span class="math inline">\(\epsilon_m\)</span> and <span class="math inline">\(\alpha_m^{learn}\)</span> vs.&nbsp;household characteristics</p></li>
<li><p>Purpose: Demonstrate realistic variation in exploration and learning behavior</p></li>
</ul>
<p><strong>D. Performance Over Time</strong></p>
<ul>
<li><p>Line plot showing monthly total costs <span class="math inline">\(C_m^{total}\)</span> with trend analysis</p></li>
<li><p>Purpose: Assess whether learning leads to improved performance</p></li>
</ul>
</section>
<section id="step-7.3-reset-for-next-year" class="level3">
<h3 class="anchored" data-anchor-id="step-7.3-reset-for-next-year">Step 7.3: Reset for Next Year</h3>
<p><strong>Prepare for Next Year:</strong></p>
<ul>
<li><p>Set <span class="math inline">\(S_1^{current} = S_{13}^{current}\)</span> (carry forward final state)</p></li>
<li><p>Set <span class="math inline">\(V_1^{default} = V_{13}^{default}\)</span> and <span class="math inline">\(V_1^{TOU} = V_{13}^{TOU}\)</span> (carry forward learned values)</p></li>
<li><p>Clear monthly arrays: <span class="math inline">\(\{C_m^{bill}, C_m^{comfort}, C_m^{total}, x_m^{switch}, S_m^{current}\}_{m=1}^{12}\)</span></p></li>
<li><p>Update annual parameters (e.g., rate changes, equipment degradation)</p></li>
<li><p>Export annual metrics to results database</p></li>
<li><p>Return to Step 1 for new annual cycle with <span class="math inline">\(m = 1\)</span></p></li>
</ul>
<p>This evaluation framework provides both quantitative metrics for model validation and intuitive visualizations for understanding consumer learning patterns and the evolution of schedule preferences over time.</p>
</section>
</section>
<section id="state-space-diagram" class="level2">
<h2 class="anchored" data-anchor-id="state-space-diagram">State space diagram</h2>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">stateDiagram-v2
  [*] --&gt; S_default: "First month"
  S_default --&gt; S_TOU: Exploration OR V_TOU &lt; V_default
  S_default --&gt; S_default: No exploration AND V_default ≤ V_TOU
  S_TOU --&gt; S_default: Exploration OR V_default &lt; V_TOU
  S_TOU --&gt; S_TOU: No exploration AND V_TOU ≤ V_default
  S_default: Default Schedule (S(current)=1)
  S_TOU: TOU-adapted Schedule (S(current)=0)
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</section>
</section>
<section id="behavioral-framework" class="level1">
<h1>4. Behavioral Framework</h1>
<p>Consumers balance exploration (trying new strategies) with exploitation (using learned knowledge). Both exploration propensity and learning speed vary systematically with household characteristics from ResStock data, creating realistic heterogeneity in decision-making behavior.</p>
</section>
<section id="consumer-information-and-decision-making-reality" class="level1">
<h1>5. Consumer Information and Decision-Making Reality</h1>
<section id="how-consumers-actually-learn-about-schedule-performance" class="level2">
<h2 class="anchored" data-anchor-id="how-consumers-actually-learn-about-schedule-performance">How Consumers Actually Learn About Schedule Performance</h2>
<p>In practice, consumers learn about HPWH schedule performance through trial-and-error rather than sophisticated analysis. They experiment with different approaches and gradually build intuition about which strategies work better for their household.</p>
<section id="the-typical-consumer-learning-journey" class="level3">
<h3 class="anchored" data-anchor-id="the-typical-consumer-learning-journey">The Typical Consumer Learning Journey</h3>
<p><strong>Month 1-3: Initial Experimentation</strong></p>
<p>Sarah starts on the default water heater schedule but decides to try TOU-friendly scheduling after reading utility materials. She programs her heat pump water heater to avoid peak hours and observes her monthly bills. Her first month shows a $15 savings, but she notices occasionally lukewarm water during evening dishwashing.</p>
<p><strong>Month 4-8: Learning Through Experience</strong></p>
<p>Sarah continues with TOU scheduling, tracking her bills mentally. Some months look like good savings ($20-25), others less clear ($5-10). She starts to notice patterns - winter months seem to have less savings, and comfort issues are more noticeable when the family has guests. Her learned value for TOU scheduling gradually incorporates both financial and comfort experiences.</p>
<p><strong>Month 9-12: Informed Decision Making</strong></p>
<p>By now Sarah has a good sense of TOU performance for her household. She’s learned that TOU scheduling typically saves $15-20/month but occasionally causes comfort issues. When bills are particularly high one month, she briefly considers switching back to default scheduling but decides her learned experience suggests TOU is still better overall.</p>
</section>
<section id="what-drives-exploration-vs-exploitation" class="level3">
<h3 class="anchored" data-anchor-id="what-drives-exploration-vs-exploitation">What Drives Exploration vs Exploitation</h3>
<p><strong>Household Characteristics Affecting Exploration:</strong></p>
<ul>
<li><strong>Income level</strong>: Higher-income households are more willing to experiment since potential losses are less consequential</li>
<li><strong>Tech comfort</strong>: Households in newer buildings with smart water heaters find it easier to try different scheduling approaches</li>
<li><strong>Household complexity</strong>: Smaller households can experiment more easily without coordination challenges</li>
</ul>
<p><strong>Learning Speed Variation:</strong></p>
<ul>
<li><strong>Education/resources</strong>: Higher-income households process bill information faster and make connections between scheduling and costs</li>
<li><strong>Technology familiarity</strong>: Tech-savvy households better understand energy feedback and scheduling impacts</li>
</ul>
</section>
<section id="implications-for-model-design" class="level3">
<h3 class="anchored" data-anchor-id="implications-for-model-design">Implications for Model Design</h3>
<p>This realistic learning process suggests the model should:</p>
<p><span class="math display">\[
\epsilon_m = \epsilon_{base} \times f_{AMI} \times \frac{1}{f_{age}} \times \frac{1}{f_{residents}} \times f_{WH}
\]</span></p>
<p>Where households with higher income, newer buildings, fewer residents, and smart water heaters explore more frequently.</p>
<p><span class="math display">\[
\alpha_m^{learn} = \alpha_{base}^{learn} \times g_{AMI} \times \frac{1}{f_{age}}
\]</span></p>
<p>Where households with higher income and newer buildings learn faster from their experiences.</p>
<p>The value learning framework captures realistic consumer decision-making through direct experience while maintaining mathematical tractability for simulation modeling.</p>
</section>
</section>
</section>
<section id="references" class="level1">
<h1>6. References</h1>
<p>This section lists references and resources for further information and context regarding the model and its implementation.</p>
<ul>
<li><p><a href="https://github.com/NREL/OCHRE/blob/main/docs/source/InputsAndArguments.rst">OCHRE Inputs and Arguments</a></p></li>
<li><p><a href="https://github.com/NREL/OCHRE/blob/main/docs/source/Outputs.rst">OCHRE Outputs</a></p></li>
<li><p><a href="https://github.com/NREL/OCHRE/blob/main/ochre/Models/Water.py">OCHRE Water Model</a></p></li>
<li><p><a href="https://github.com/NREL/OCHRE/blob/main/ochre/Equipment/WaterHeater.py">HPWH Control Logic</a></p></li>
</ul>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button,
          { trigger: "manual",
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config);
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined;
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              }
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            }
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>

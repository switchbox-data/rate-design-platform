# NYISO ICAP clearing prices pipeline
#
# Fetch monthly clearing prices (Spot, Monthly, Strip auctions) for all four
# NYISO capacity localities (NYCA, GHIJ, NYC, LI) via gridstatus, write to
# Hive-partitioned parquet, and upload to S3.
#
# Run from repo root: just -f data/nyiso/icap/Justfile <recipe>
# Or from this dir:   just <recipe>

path_local_repo := `git rev-parse --show-toplevel`
path_local_base := justfile_directory()
path_local_parquet := path_local_base + "/parquet"
path_s3_parquet := "s3://data.sb/nyiso/icap/"

# Defaults (override: just start=2020 end=2025 fetch)
start := "2014"
end := "2025"

# Fetch: gridstatus â†’ local Hive-partitioned parquet (year={YYYY}/month={M}/data.parquet)
fetch:
    uv run python "{{path_local_base}}/fetch_icap_clearing_prices.py" \
        --start "{{start}}" --end "{{end}}" \
        --path-local-parquet "{{path_local_parquet}}"

# Validate: run QA checks on local parquet
validate:
    uv run python "{{path_local_base}}/validate_icap_parquet.py" \
        --path-local-parquet "{{path_local_parquet}}"

# Upload: sync local parquet to S3
upload:
    aws s3 sync "{{path_local_parquet}}/" "{{path_s3_parquet}}" \
        --exclude "*" --include "*.parquet"
    @echo "Uploaded to {{path_s3_parquet}}"

# Update: discover latest month on S3, fetch new months only (no upload)
update:
    uv run python "{{path_local_base}}/update_icap_to_latest.py" \
        --path-local-parquet "{{path_local_parquet}}" \
        --path-s3-parquet "{{path_s3_parquet}}"

# Prepare: fetch + validate (no upload)
prepare: fetch validate

# Clean: remove local parquet
clean:
    rm -rf "{{path_local_parquet}}"
    @echo "Removed parquet/"

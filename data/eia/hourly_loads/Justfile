# EIA hourly zone and utility load data pipeline
#
# Fetch zone loads from EIA API and aggregate to utility-level profiles.
# Invoked from rate_design/{ny,ri}/hp_rates/Justfile PRE section.
#
# Usage (standalone, from project root):
#   just -f data/eia/hourly_loads/Justfile fetch-zone-data
#   just -f data/eia/hourly_loads/Justfile aggregate-utility-loads
#
# Or with defaults from hp_rates PRE section:
#   just pre-fetch-zone-data   (from rate_design/ny/hp_rates or ri/hp_rates)

path_local_repo := `git rev-parse --show-toplevel`
path_s3_zone_parquet := "s3://data.sb/eia/hourly_demand/zones/"
path_s3_utility_parquet := "s3://data.sb/eia/hourly_demand/utilities/"

# Fetch zonal load data from EIA API for a state and month range.
# Pass state, start_month, end_month via environment or as arguments.
fetch-zone-data state start_month end_month:
    #!/usr/bin/env bash
    s="{{state}}"
    sm="{{start_month}}"
    em="{{end_month}}"
    if [[ -z "$s" || -z "$sm" || -z "$em" ]]; then
        echo "Usage: just fetch-zone-data <state> <start_month> <end_month>"
        echo "Example: just fetch-zone-data NY 2025-01 2025-12"
        exit 1
    fi
    uv run python "{{path_local_repo}}/data/eia/hourly_loads/fetch_zone_loads_parquet.py" \
        --state "$s" \
        --start-month "$sm" \
        --end-month "$em" \
        --path-s3-zone-parquet {{path_s3_zone_parquet}}

# Aggregate zone loads to utility-level profiles.
# Pass state, year, utility via environment or as arguments.
aggregate-utility-loads state year utility:
    #!/usr/bin/env bash
    s="{{state}}"
    y="{{year}}"
    u="{{utility}}"
    if [[ -z "$s" || -z "$y" || -z "$u" ]]; then
        echo "Usage: just aggregate-utility-loads <state> <year> <utility>"
        echo "Example: just aggregate-utility-loads NY 2025 nyseg"
        exit 1
    fi
    uv run python "{{path_local_repo}}/data/eia/hourly_loads/aggregate_eia_utility_loads.py" \
        --state "$s" \
        --year "$y" \
        --utility "$u" \
        --path-s3-zone-parquet {{path_s3_zone_parquet}} \
        --path-s3-utility-parquet {{path_s3_utility_parquet}} \
        --upload

# EIA hourly zone and utility load data pipeline
#
# Fetch zone loads from EIA API and aggregate to utility-level profiles (local parquet).
# Upload syncs local dirs to S3 (same layout). Data is small; run fetch then aggregate then upload.
#
# Usage (from project root):
#   just -f data/eia/hourly_loads/Justfile fetch-zone-data NY 2025-01 2025-12
#   just -f data/eia/hourly_loads/Justfile aggregate-utility-loads NY 2025 nyseg
#   just -f data/eia/hourly_loads/Justfile aggregate-all-utility-loads NY 2025
#   just -f data/eia/hourly_loads/Justfile download
#   just -f data/eia/hourly_loads/Justfile upload
#   just -f data/eia/hourly_loads/Justfile clean

path_local_repo := `git rev-parse --show-toplevel`
path_local_zone_parquet := path_local_repo + "/data/eia/hourly_loads/zone_parquet/"
path_local_utility_parquet := path_local_repo + "/data/eia/hourly_loads/utility_parquet/"
path_s3_zone_parquet := "s3://data.sb/eia/hourly_demand/zones/"
path_s3_utility_parquet := "s3://data.sb/eia/hourly_demand/utilities/"

# Fetch zonal load data from EIA API; write to local parquet.
fetch-zone-data state start_month end_month:
    #!/usr/bin/env bash
    s="{{state}}"
    sm="{{start_month}}"
    em="{{end_month}}"
    if [[ -z "$s" || -z "$sm" || -z "$em" ]]; then
        echo "Usage: just fetch-zone-data <state> <start_month> <end_month>"
        echo "Example: just fetch-zone-data NY 2025-01 2025-12"
        exit 1
    fi
    uv run python "{{path_local_repo}}/data/eia/hourly_loads/fetch_zone_loads_parquet.py" \
        --state "$s" \
        --start-month "$sm" \
        --end-month "$em" \
        --path-local-zone-parquet "{{path_local_zone_parquet}}"

# Aggregate zone loads to utility-level profiles; read/write local parquet.
aggregate-utility-loads state year utility:
    #!/usr/bin/env bash
    s="{{state}}"
    y="{{year}}"
    u="{{utility}}"
    if [[ -z "$s" || -z "$y" || -z "$u" ]]; then
        echo "Usage: just aggregate-utility-loads <state> <year> <utility>"
        echo "Example: just aggregate-utility-loads NY 2025 nyseg"
        exit 1
    fi
    uv run python "{{path_local_repo}}/data/eia/hourly_loads/aggregate_eia_utility_loads.py" \
        --state "$s" \
        --year "$y" \
        --utility "$u" \
        --path-local-zone-parquet "{{path_local_zone_parquet}}" \
        --path-local-utility-parquet "{{path_local_utility_parquet}}"

# Aggregate zone loads for ALL utilities in a state; read/write local parquet.
aggregate-all-utility-loads state year:
    #!/usr/bin/env bash
    s="{{state}}"
    y="{{year}}"
    if [[ -z "$s" || -z "$y" ]]; then
        echo "Usage: just aggregate-all-utility-loads <state> <year>"
        echo "Example: just aggregate-all-utility-loads NY 2025"
        exit 1
    fi
    uv run python "{{path_local_repo}}/data/eia/hourly_loads/aggregate_eia_utility_loads.py" \
        --state "$s" \
        --year "$y" \
        --utility all \
        --path-local-zone-parquet "{{path_local_zone_parquet}}" \
        --path-local-utility-parquet "{{path_local_utility_parquet}}"

# Download zone and utility parquet from S3 to local (inverse of upload).
download:
    aws s3 sync "{{path_s3_zone_parquet}}" "{{path_local_zone_parquet}}" --exclude "*" --include "*.parquet"
    aws s3 sync "{{path_s3_utility_parquet}}" "{{path_local_utility_parquet}}" --exclude "*" --include "*.parquet"
    @echo "Synced zone and utility parquet from S3 to local"

# Sync local zone and utility parquet to S3 (same layout).
upload:
    aws s3 sync "{{path_local_zone_parquet}}" "{{path_s3_zone_parquet}}" --exclude "*" --include "*.parquet"
    aws s3 sync "{{path_local_utility_parquet}}" "{{path_s3_utility_parquet}}" --exclude "*" --include "*.parquet"
    @echo "Synced zone and utility parquet to S3"

# Remove local parquet dirs.
clean:
    rm -rf "{{path_local_zone_parquet}}" "{{path_local_utility_parquet}}"
    @echo "Removed zone_parquet/, utility_parquet/"

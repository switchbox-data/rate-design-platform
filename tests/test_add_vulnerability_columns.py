"""Tests for vulnerability column assignment (random placeholder)."""

from __future__ import annotations

from typing import cast

import polars as pl

from data.resstock.add_vulnerability_columns import add_vulnerability_columns


def _make_metadata(n: int = 100) -> pl.LazyFrame:
    return pl.DataFrame({"bldg_id": list(range(1, n + 1))}).lazy()


def test_columns_added() -> None:
    meta = _make_metadata(50)
    result = cast(pl.DataFrame, add_vulnerability_columns(meta, seed=42).collect())
    for col in [
        "has_child_under_6",
        "has_person_over_60",
        "has_disabled_person",
        "is_vulnerable",
    ]:
        assert col in result.columns, f"Missing column {col}"
    assert result.height == 50


def test_is_vulnerable_is_composite() -> None:
    meta = _make_metadata(200)
    df = cast(pl.DataFrame, add_vulnerability_columns(meta, seed=99).collect())
    # is_vulnerable should be True wherever any component is True
    expected = (
        df["has_child_under_6"] | df["has_person_over_60"] | df["has_disabled_person"]
    )
    assert df["is_vulnerable"].to_list() == expected.to_list()


def test_deterministic_with_same_seed() -> None:
    meta = _make_metadata(100)
    df1 = cast(pl.DataFrame, add_vulnerability_columns(meta, seed=7).collect())
    df2 = cast(pl.DataFrame, add_vulnerability_columns(meta, seed=7).collect())
    assert df1["is_vulnerable"].to_list() == df2["is_vulnerable"].to_list()


def test_different_seed_gives_different_result() -> None:
    meta = _make_metadata(500)
    df1 = cast(pl.DataFrame, add_vulnerability_columns(meta, seed=1).collect())
    df2 = cast(pl.DataFrame, add_vulnerability_columns(meta, seed=2).collect())
    # Very unlikely to be identical with different seeds and 500 rows
    assert df1["is_vulnerable"].to_list() != df2["is_vulnerable"].to_list()


def test_rates_approximately_correct() -> None:
    """With many rows, observed rates should be near the specified rates."""
    meta = _make_metadata(10000)
    df = cast(
        pl.DataFrame,
        add_vulnerability_columns(
            meta,
            seed=42,
            rate_child_under_6=0.20,
            rate_person_over_60=0.35,
            rate_disabled=0.15,
        ).collect(),
    )
    child_rate = df["has_child_under_6"].sum() / df.height
    elder_rate = df["has_person_over_60"].sum() / df.height
    disabled_rate = df["has_disabled_person"].sum() / df.height
    assert 0.15 < child_rate < 0.25
    assert 0.30 < elder_rate < 0.40
    assert 0.10 < disabled_rate < 0.20

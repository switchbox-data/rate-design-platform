# RI heat pump tasks (placeholder).

# Resolve project root as absolute path using git
project_root := `git rev-parse --show-toplevel`
ri_run_scenario_config := project_root + "/rate_design/ri/hp_rates/config/scenarios.yaml"

# -----------------------------------------------------------------------------
# Run RI scenarios
# -----------------------------------------------------------------------------
# Example:
# just run-scenario 1
run-scenario run_num scenario_config=ri_run_scenario_config:
  uv run python {{project_root}}/rate_design/ri/hp_rates/run_scenario.py \
    --run-num "{{run_num}}" \
    --scenario-config "{{scenario_config}}"

# Optional: full output path override (else path_output/state/run_name/runtime from YAML)
run-scenario-with-output run_num output_dir scenario_config=ri_run_scenario_config:
  uv run python {{project_root}}/rate_design/ri/hp_rates/run_scenario.py \
    --run-num "{{run_num}}" \
    --scenario-config "{{scenario_config}}" \
    --output-dir "{{output_dir}}"

# -----------------------------------------------------------------------------
# Post-processing
# -----------------------------------------------------------------------------

# Revenue requirement YAML outputs from CAIRO BAT results.
ri_rev_requirement_dir := project_root + "/rate_design/ri/hp_rates/config/rev_requirement"
ri_differentiated_rev_requirement_yaml := ri_rev_requirement_dir + "/rie_hp_vs_nonhp.yaml"
ri_default_rev_requirement_yaml := ri_rev_requirement_dir + "/rie.yaml"

compute-subclass-rr run_dir run_num="1" scenario_config=ri_run_scenario_config group_col="has_hp" cross_subsidy_col="BAT_percustomer" differentiated_yaml=ri_differentiated_rev_requirement_yaml default_yaml=ri_default_rev_requirement_yaml:
  uv run python {{project_root}}/utils/post/compute_subclass_rr.py \
    --run-dir "{{run_dir}}" \
    --run-num "{{run_num}}" \
    --scenario-config "{{scenario_config}}" \
    --group-col "{{group_col}}" \
    --cross-subsidy-col "{{cross_subsidy_col}}" \
    --differentiated-yaml-path "{{differentiated_yaml}}" \
    --default-yaml-path "{{default_yaml}}"

# Seasonal discount inputs from run outputs + ResStock loads.
compute-seasonal-discount-inputs run_dir resstock_loads_path cross_subsidy_col="BAT_percustomer" output_dir="":
  uv run python {{project_root}}/utils/post/compute_subclass_rr.py \
    --run-dir "{{run_dir}}" \
    --group-col "has_hp" \
    --cross-subsidy-col "{{cross_subsidy_col}}" \
    --no-write-revenue-requirement-yamls \
    --resstock-loads-path "{{resstock_loads_path}}" \
    {{ if output_dir != "" { "--output-dir \"" + output_dir + "\"" } else { "" } }}

# Tariff JSON creation from seasonal_discount_rate_inputs.csv.
create-seasonal-discount-tariff base_tariff_json seasonal_inputs_csv label output_path:
  uv run python {{project_root}}/utils/pre/create_seasonal_discount_tariff.py \
    --base-tariff-json "{{base_tariff_json}}" \
    --seasonal-inputs-csv "{{seasonal_inputs_csv}}" \
    --label "{{label}}" \
    --output-path "{{output_path}}"

ri_tariffs_electric_dir := project_root + "/rate_design/ri/hp_rates/config/tariffs/electric"
ri_hp_seasonal_calibrated_tariff := ri_tariffs_electric_dir + "/rie_hp_seasonal_calibrated.json"
ri_hp_seasonal_calibrated_supply_tariff := ri_tariffs_electric_dir + "/rie_hp_seasonal_calibrated_supply.json"

# Run 1 (delivery-only) calibrated seasonal tariff.
create-rie-hp-seasonal-calibrated seasonal_inputs_csv:
  just create-seasonal-discount-tariff \
    {{ri_tariffs_electric_dir}}/rie_a16.json \
    "{{seasonal_inputs_csv}}" \
    rie_hp_seasonal_calibrated \
    {{ri_hp_seasonal_calibrated_tariff}}

# Run 2 (delivery + supply) calibrated seasonal tariff.
create-rie-hp-seasonal-calibrated-supply seasonal_inputs_csv:
  just create-seasonal-discount-tariff \
    {{ri_tariffs_electric_dir}}/rie_a16_supply_adj.json \
    "{{seasonal_inputs_csv}}" \
    rie_hp_seasonal_calibrated_supply \
    {{ri_hp_seasonal_calibrated_supply_tariff}}

# -----------------------------------------------------------------------------
# PRE: Tariff mapping (electric and gas)
# -----------------------------------------------------------------------------
path_s3_resstock_metadata := "s3://data.sb/nrel/resstock/res_2024_amy2018_2/metadata"
tariff_maps_dir_ri := "{{project_root}}/rate_design/ri/hp_rates/config/tariff_maps"

map-electric-tariff electric_utility SB_scenario_type SB_scenario_year upgrade_id output_dir:
  uv run python {{project_root}}/utils/pre/electric_tariff_mapper.py \
    --metadata_path "{{path_s3_resstock_metadata}}" \
    --state RI \
    --upgrade_id "{{upgrade_id}}" \
    --electric_utility "{{electric_utility}}" \
    --SB_scenario_type "{{SB_scenario_type}}" \
    --SB_scenario_year "{{SB_scenario_year}}" \
    --output_dir "{{output_dir}}"

map-electric-coned-default:
  just map-electric-tariff coned default 1 00 {{tariff_maps_dir_ri}}/electric

map-electric-coned-seasonal:
  just map-electric-tariff coned seasonal 1 00 {{tariff_maps_dir_ri}}/electric

map-electric-coned-class-specific-seasonal:
  just map-electric-tariff coned class_specific_seasonal 1 00 {{tariff_maps_dir_ri}}/electric

map-electric-national-grid-default:
  just map-electric-tariff nimo default 1 00 {{tariff_maps_dir_ri}}/electric

map-electric-national-grid-seasonal:
  just map-electric-tariff nimo seasonal 1 00 {{tariff_maps_dir_ri}}/electric

map-electric-national-grid-class-specific-seasonal:
  just map-electric-tariff nimo class_specific_seasonal 1 00 {{tariff_maps_dir_ri}}/electric

map-electric-nyseg-default:
  just map-electric-tariff nyseg default 1 00 {{tariff_maps_dir_ri}}/electric

map-electric-nyseg-seasonal:
  just map-electric-tariff nyseg seasonal 1 00 {{tariff_maps_dir_ri}}/electric

map-electric-nyseg-class-specific-seasonal:
  just map-electric-tariff nyseg class_specific_seasonal 1 00 {{tariff_maps_dir_ri}}/electric

map-electric-rie-default:
  just map-electric-tariff rie default 1 00 {{tariff_maps_dir_ri}}/electric

map-electric-rie-seasonal:
  just map-electric-tariff rie seasonal 1 00 {{tariff_maps_dir_ri}}/electric

map-electric-rie-seasonal-discount:
  just map-electric-tariff rie seasonal_discount 1 00 {{tariff_maps_dir_ri}}/electric

map-gas-tariff electric_utility upgrade_id output_dir:
  uv run python {{project_root}}/utils/pre/gas_tariff_mapper.py \
    --metadata_path "{{path_s3_resstock_metadata}}" \
    --state RI \
    --upgrade_id "{{upgrade_id}}" \
    --electric_utility "{{electric_utility}}" \
    --output_dir "{{output_dir}}"

map-gas-coned-default:
  just map-gas-tariff coned 00 {{tariff_maps_dir_ri}}/gas

map-gas-coned-seasonal:
  just map-gas-tariff coned 00 {{tariff_maps_dir_ri}}/gas

map-gas-coned-class-specific-seasonal:
  just map-gas-tariff coned 00 {{tariff_maps_dir_ri}}/gas

map-gas-national-grid-default:
  just map-gas-tariff nimo 00 {{tariff_maps_dir_ri}}/gas

map-gas-national-grid-seasonal:
  just map-gas-tariff nimo 00 {{tariff_maps_dir_ri}}/gas

map-gas-national-grid-class-specific-seasonal:
  just map-gas-tariff nimo 00 {{tariff_maps_dir_ri}}/gas

map-gas-nyseg-default:
  just map-gas-tariff nyseg 00 {{tariff_maps_dir_ri}}/gas

map-gas-nyseg-seasonal:
  just map-gas-tariff nyseg 00 {{tariff_maps_dir_ri}}/gas

map-gas-nyseg-class-specific-seasonal:
  just map-gas-tariff nyseg 00 {{tariff_maps_dir_ri}}/gas

map-gas-rie-default:
  just map-gas-tariff rie 00 {{tariff_maps_dir_ri}}/gas

# -----------------------------------------------------------------------------
# Post-processing: RI LIDR+ discounts
# -----------------------------------------------------------------------------
# Apply RI LIDR+ discounts to CAIRO bills. Requires CPI parquet on S3 (e.g. from data/fred/cpi); pass --cpi-s3-path.
apply-ri-lmi-discounts run_dir state utility fpl_year cpi_s3_path participation_rate="1.0" rider="false":
  uv run python {{project_root}}/utils/post/apply_ri_lmi_discounts_to_bills.py \
    --run-dir "{{run_dir}}" \
    --state {{state}} \
    --utility {{utility}} \
    --fpl-year {{fpl_year}} \
    --cpi-s3-path "{{cpi_s3_path}}" \
    --participation-rate {{participation_rate}} \
    {{ if rider == "true" { "--rider" } else { "" } }} \
    --upload

# -----------------------------------------------------------------------------
# PRE: Marginal cost allocation (utility loads and MC table â†’ S3; data assumed on S3)
# -----------------------------------------------------------------------------
pre_state := "RI"
pre_utility := "rie"
pre_load_year := "2025"
pre_mc_year := "2025"
pre_mc_table_path := project_root + "/rate_design/ri/hp_rates/config/marginal_costs/ri_marginal_costs_2025.csv"
pre_utility_s3_base := "s3://data.sb/eia/hourly_demand/utilities/"
pre_mc_output_s3_base := "s3://data.sb/switchbox/marginal_costs/ri/"

create-td-mc-data:
  cd {{project_root}} && uv run python {{project_root}}/utils/pre/generate_utility_tx_dx_mc.py \
    --state {{pre_state}} \
    --utility {{pre_utility}} \
    --mc-year {{pre_mc_year}} \
    --load-year {{pre_load_year}} \
    --mc-table-path {{pre_mc_table_path}} \
    --utility-load-s3-base {{pre_utility_s3_base}} \
    --output-s3-base {{pre_mc_output_s3_base}} \
    --upload

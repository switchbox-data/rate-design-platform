# RI heat pump tasks (placeholder).

# Resolve project root as absolute path using git
project_root := `git rev-parse --show-toplevel`
ri_run_scenario_config := project_root + "/rate_design/ri/hp_rates/config/scenarios.yaml"

# -----------------------------------------------------------------------------
# Run RI scenarios
# -----------------------------------------------------------------------------
# Example:
# just run-scenario 1
run-scenario run_num scenario_config=ri_run_scenario_config:
  uv run python {{project_root}}/rate_design/ri/hp_rates/run_scenario.py \
    --run-num "{{run_num}}" \
    --scenario-config "{{scenario_config}}"

# Optional output override (if you don't want the YAML output_dir)
run-scenario-with-output run_num output_dir scenario_config=ri_run_scenario_config:
  uv run python {{project_root}}/rate_design/ri/hp_rates/run_scenario.py \
    --run-num "{{run_num}}" \
    --scenario-config "{{scenario_config}}" \
    --output-dir "{{output_dir}}"

# -----------------------------------------------------------------------------
# PRE: Derive seasonal TOU tariff from marginal costs
# -----------------------------------------------------------------------------
# Produces tariff JSON, tariff map CSV, and derivation spec JSON under config/.
# Run this BEFORE run-scenario for runs that use demand_flex (e.g. run 3).
#
# Example:
#   just derive-seasonal-tou rie_seasonal_tou_hp rie_a16
derive-seasonal-tou tou_tariff_key flat_tariff_key \
    cambium_path="s3://data.sb/nrel/cambium/2024/scenario=MidCase/t=2025/gea=ISONE/r=p133/data.parquet" \
    state="RI" region="isone" utility="rie" year="2025" \
    upgrade="00" customer_count="451381" \
    summer_months="6,7,8,9" tou_window_hours="4" \
    tou_base_rate="0.06" tou_fixed_charge="6.75":
  uv run python -m utils.pre.derive_seasonal_tou \
    --cambium-path "{{cambium_path}}" \
    --state "{{state}}" --region "{{region}}" --utility "{{utility}}" --year "{{year}}" \
    --resstock-metadata-path "/data.sb/nrel/resstock/res_2024_amy2018_2/metadata/state={{state}}/upgrade={{upgrade}}/metadata-sb.parquet" \
    --resstock-loads-path "/data.sb/nrel/resstock/res_2024_amy2018_2/load_curve_hourly/state={{state}}/upgrade={{upgrade}}" \
    --customer-count "{{customer_count}}" \
    --summer-months "{{summer_months}}" \
    --tou-window-hours "{{tou_window_hours}}" \
    --tou-base-rate "{{tou_base_rate}}" \
    --tou-fixed-charge "{{tou_fixed_charge}}" \
    --tou-tariff-key "{{tou_tariff_key}}" \
    --flat-tariff-key "{{flat_tariff_key}}" \
    --output-dir "{{project_root}}/rate_design/ri/hp_rates/config"

# -----------------------------------------------------------------------------
# PRE: ResStock (delegates to data/resstock/Justfile)
# -----------------------------------------------------------------------------
resstock-download:
  just -f {{project_root}}/data/resstock/Justfile resstock-download RI

resstock-test-download:
  just -f {{project_root}}/data/resstock/Justfile resstock-test-download RI

resstock-identify-hp-customers:
  just -f {{project_root}}/data/resstock/Justfile resstock-identify-hp-customers RI

# -----------------------------------------------------------------------------
# PRE: Tariff mapping (electric and gas)
# -----------------------------------------------------------------------------
path_s3_resstock_metadata := "s3://data.sb/nrel/resstock/res_2024_amy2018_2/metadata"
tariff_maps_dir_ri := "{{project_root}}/rate_design/ri/hp_rates/config/tariff_maps"

map-electric-tariff electric_utility SB_scenario_type SB_scenario_year upgrade_id output_dir:
  uv run python {{project_root}}/utils/pre/electric_tariff_mapper.py \
    --metadata_path "{{path_s3_resstock_metadata}}" \
    --state RI \
    --upgrade_id "{{upgrade_id}}" \
    --electric_utility "{{electric_utility}}" \
    --SB_scenario_type "{{SB_scenario_type}}" \
    --SB_scenario_year "{{SB_scenario_year}}" \
    --output_dir "{{output_dir}}"

map-electric-coned-default:
  just map-electric-tariff coned default 1 00 {{tariff_maps_dir_ri}}/electric

map-electric-coned-seasonal:
  just map-electric-tariff coned seasonal 1 00 {{tariff_maps_dir_ri}}/electric

map-electric-coned-class-specific-seasonal:
  just map-electric-tariff coned class_specific_seasonal 1 00 {{tariff_maps_dir_ri}}/electric

map-electric-national-grid-default:
  just map-electric-tariff nimo default 1 00 {{tariff_maps_dir_ri}}/electric

map-electric-national-grid-seasonal:
  just map-electric-tariff nimo seasonal 1 00 {{tariff_maps_dir_ri}}/electric

map-electric-national-grid-class-specific-seasonal:
  just map-electric-tariff nimo class_specific_seasonal 1 00 {{tariff_maps_dir_ri}}/electric

map-electric-nyseg-default:
  just map-electric-tariff nyseg default 1 00 {{tariff_maps_dir_ri}}/electric

map-electric-nyseg-seasonal:
  just map-electric-tariff nyseg seasonal 1 00 {{tariff_maps_dir_ri}}/electric

map-electric-nyseg-class-specific-seasonal:
  just map-electric-tariff nyseg class_specific_seasonal 1 00 {{tariff_maps_dir_ri}}/electric

map-electric-rie-default:
  just map-electric-tariff rie default 1 00 {{tariff_maps_dir_ri}}/electric

# Generate TOU tariff map: HP customers → TOU, non-HP → flat.
# Requires ResStock metadata on S3 (run resstock-identify-hp-customers first).
map-electric-tou tou_tariff_key flat_tariff_key upgrade_id="00":
  uv run python -m utils.pre.compute_tou \
    --metadata-path "{{path_s3_resstock_metadata}}/state=RI/upgrade={{upgrade_id}}/metadata-sb.parquet" \
    --tou-tariff-key "{{tou_tariff_key}}" \
    --flat-tariff-key "{{flat_tariff_key}}" \
    --output-dir "{{tariff_maps_dir_ri}}/electric"

map-gas-tariff electric_utility upgrade_id output_dir:
  uv run python {{project_root}}/utils/pre/gas_tariff_mapper.py \
    --metadata_path "{{path_s3_resstock_metadata}}" \
    --state RI \
    --upgrade_id "{{upgrade_id}}" \
    --electric_utility "{{electric_utility}}" \
    --output_dir "{{output_dir}}"

map-gas-coned-default:
  just map-gas-tariff coned 00 {{tariff_maps_dir_ri}}/gas

map-gas-coned-seasonal:
  just map-gas-tariff coned 00 {{tariff_maps_dir_ri}}/gas

map-gas-coned-class-specific-seasonal:
  just map-gas-tariff coned 00 {{tariff_maps_dir_ri}}/gas

map-gas-national-grid-default:
  just map-gas-tariff nimo 00 {{tariff_maps_dir_ri}}/gas

map-gas-national-grid-seasonal:
  just map-gas-tariff nimo 00 {{tariff_maps_dir_ri}}/gas

map-gas-national-grid-class-specific-seasonal:
  just map-gas-tariff nimo 00 {{tariff_maps_dir_ri}}/gas

map-gas-nyseg-default:
  just map-gas-tariff nyseg 00 {{tariff_maps_dir_ri}}/gas

map-gas-nyseg-seasonal:
  just map-gas-tariff nyseg 00 {{tariff_maps_dir_ri}}/gas

map-gas-nyseg-class-specific-seasonal:
  just map-gas-tariff nyseg 00 {{tariff_maps_dir_ri}}/gas

map-gas-rie-default:
  just map-gas-tariff rie 00 {{tariff_maps_dir_ri}}/gas

# -----------------------------------------------------------------------------
# Post-processing: CPI and RI LIDR+ discounts
# -----------------------------------------------------------------------------
# Delegates to data/fred/cpi/Justfile.
fetch-cpi series="CPIAUCSL" start_year="2020" end_year="2025":
  just -f {{project_root}}/data/fred/cpi/Justfile fetch-cpi {{series}} {{start_year}} {{end_year}}

# Apply RI LIDR+ discounts to CAIRO bills. Run fetch-cpi first, then pass --cpi-s3-path.
apply-ri-lmi-discounts run_dir state utility fpl_year cpi_s3_path participation_rate="1.0" rider="false":
  uv run python {{project_root}}/utils/post/apply_ri_lmi_discounts_to_bills.py \
    --run-dir "{{run_dir}}" \
    --state {{state}} \
    --utility {{utility}} \
    --fpl-year {{fpl_year}} \
    --cpi-s3-path "{{cpi_s3_path}}" \
    --participation-rate {{participation_rate}} \
    {{ if rider == "true" { "--rider" } else { "" } }} \
    --upload

# -----------------------------------------------------------------------------
# PRE: EIA hourly loads and marginal cost allocation (zone fetch, utility aggregate, MC allocation)
# -----------------------------------------------------------------------------
pre_state := "RI"
pre_utility := "rie"
pre_start_month := "2025-01"
pre_end_month := "2025-12"
pre_load_year := "2025"
pre_mc_year := "2025"
pre_mc_table_path := project_root + "/rate_design/ri/hp_rates/config/marginal_costs/ri_marginal_costs_2025.csv"
pre_zone_s3_base := "s3://data.sb/eia/hourly_demand/zones/"
pre_utility_s3_base := "s3://data.sb/eia/hourly_demand/utilities/"
pre_mc_output_s3_base := "s3://data.sb/switchbox/marginal_costs/ri/"

create-td-mc-data:
  just create-td-mc-data-rie

create-td-mc-data-rie:
  just -f {{project_root}}/data/eia/hourly_loads/Justfile fetch-zone-data {{pre_state}} {{pre_start_month}} {{pre_end_month}}
  just -f {{project_root}}/data/eia/hourly_loads/Justfile aggregate-utility-loads {{pre_state}} {{pre_load_year}} {{pre_utility}}
  cd {{project_root}} && uv run python {{project_root}}/utils/pre/generate_utility_tx_dx_mc.py \
    --state {{pre_state}} \
    --utility {{pre_utility}} \
    --mc-year {{pre_mc_year}} \
    --load-year {{pre_load_year}} \
    --mc-table-path {{pre_mc_table_path}} \
    --utility-load-s3-base {{pre_utility_s3_base}} \
    --output-s3-base {{pre_mc_output_s3_base}} \
    --upload

# NY heat pump tasks (placeholder).

s3_base := "s3://data.sb"
# Resolve project root as absolute path using git
project_root := `git rev-parse --show-toplevel`

# Download NY electric and gas utility polygons from NY Open Data.
download-ny-utility-polygons:
	just download-ny-electric-utility-polygons
	just download-ny-gas-utility-polygons

download-ny-electric-utility-polygons:
	wget -qO- --user-agent="Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:89.0) Gecko/20100101 Firefox/89.0" "https://data.ny.gov/api/views/i7nm-ih89/rows.csv" | aws s3 cp - "{{s3_base}}/gis/utility_boundaries/ny_electric_utilities_$(date +%Y%m%d).csv"
	just test-ny-electric-utility-polygons-download

download-ny-gas-utility-polygons:
	wget -qO- --user-agent="Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:89.0) Gecko/20100101 Firefox/89.0" "https://data.ny.gov/api/views/i7nm-ih89/rows.csv" | aws s3 cp - "{{s3_base}}/gis/utility_boundaries/ny_gas_utilities_$(date +%Y%m%d).csv"
	just test-ny-gas-utility-polygons-download

test-ny-electric-utility-polygons-download:
	aws s3 ls "{{s3_base}}/gis/utility_boundaries/" | grep "ny_electric_utilities_.*\.csv"

test-ny-gas-utility-polygons-download:
	aws s3 ls "{{s3_base}}/gis/utility_boundaries/" | grep "ny_gas_utilities_.*\.csv"

# Assign electric and gas utilities to ResStock buildings in NY.
assign-ny-utilities release upgrade:
	just download-ny-utility-polygons
	uv run python {{project_root}}/utils/assign_utility_ny.py \
		--input_metadata_dir "s3://data.sb/nrel/resstock/{{release}}/metadata/state=NY/upgrade={{upgrade}}/" \
		--input_metadata_filename "metadata-sb.parquet" \
		--output_metadata_dir "s3://data.sb/nrel/resstock/{{release}}/metadata_utility/state=NY/" \
		--output_utility_assignment_filename "utility_assignment.parquet" \
		--electric_poly_dir "s3://data.sb/gis/utility_boundaries/" \
		--gas_poly_dir "s3://data.sb/gis/utility_boundaries/" \
		--electric_poly_filename "ny_electric_utilities_20260216.csv" \
		--gas_poly_filename "ny_gas_utilities_20260216.csv"

assign-ny-utilities-amy2018-2:
	just assign-ny-utilities res_2024_amy2018_2 00

# Identify HP customers
identify-hp-customers release upgrade_ids input_filename output_filename:
  #!/usr/bin/env bash
  set -e
  if [[ "{{release}}" != *"2024"* ]]; then
    echo "Warning: this task is only verified to work with 2024 releases. It may work with other releases, but has not been tested."
  fi
  for upgrade_id in {{upgrade_ids}}; do
    uv run python {{project_root}}/utils/identify_hp_customers.py \
      --input_dir "s3://data.sb/nrel/resstock/{{release}}/metadata/state=NY/upgrade=$upgrade_id" \
      --output_dir "s3://data.sb/nrel/resstock/{{release}}/metadata/state=NY/upgrade=$upgrade_id" \
      --input_filename "{{input_filename}}" \
      --output_filename "{{output_filename}}" \
      --upgrade_id "$upgrade_id"
  done

identify-hp-customers-all-upgrades-2024-amy2018-2-ny:
  just identify-hp-customers "res_2024_amy2018_2" "00 01 02 03 04 05" "metadata.parquet" "metadata-sb.parquet"

# Identify heating type
identify-heating-type release upgrade_ids input_filename output_filename:
  #!/usr/bin/env bash
  set -e
  if [[ "{{release}}" != *"2024"* ]]; then
    echo "Warning: this task is only verified to work with 2024 releases. It may work with other releases, but has not been tested."
  fi
  for upgrade_id in {{upgrade_ids}}; do
    uv run python {{project_root}}/utils/identify_heating_type.py \
      --input_dir "s3://data.sb/nrel/resstock/{{release}}/metadata/state=NY/upgrade=$upgrade_id" \
      --output_dir "s3://data.sb/nrel/resstock/{{release}}/metadata/state=NY/upgrade=$upgrade_id" \
      --input_filename "{{input_filename}}" \
      --output_filename "{{output_filename}}" \
      --upgrade_id "$upgrade_id"
  done

identify-heating-type-all-upgrades-2024-amy2018-2-ny:
  just identify-heating-type "res_2024_amy2018_2" "00 01 02 03 04 05" "metadata.parquet" "metadata-sb.parquet"

# Identify HP customers and heating type
identify-hp-customers-and-heating-type-all-upgrades-2024-amy2018-2-ny:
  just identify-hp-customers "res_2024_amy2018_2" "00 01 02 03 04 05" "metadata.parquet" "metadata-sb.parquet"
  just identify-heating-type "res_2024_amy2018_2" "00 01 02 03 04 05" "metadata-sb.parquet" "metadata-sb.parquet"

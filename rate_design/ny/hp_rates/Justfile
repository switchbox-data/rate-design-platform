# NY heat pump rate design tasks.
# Parameterized for multi-utility reuse via env vars.
# See context/tools/run_orchestration.md for full documentation.

# =============================================================================
# Tier 1: Identity (override via env vars)
# =============================================================================

state       := env_var_or_default('STATE', 'ny')
state_upper := uppercase(state)
utility     := env_var_or_default('UTILITY', 'nyseg')

# =============================================================================
# Tier 2: Utility-specific config (override via env vars if needed)
# =============================================================================
# Most values are uniform across NY utilities or derived from `utility`.
# Just pass UTILITY=<name> to switch utilities:
#   UTILITY=coned just run-1

region            := env_var_or_default('REGION', 'nyiso')
year              := env_var_or_default('YEAR', '2026')
mc_year           := env_var_or_default('MC_YEAR', '2026')
upgrade           := env_var_or_default('UPGRADE', '00')
default_tariff        := env_var_or_default('DEFAULT_TARIFF', utility + '_default.json')
default_tariff_supply := env_var_or_default('DEFAULT_TARIFF_SUPPLY', utility + '_default.json')
upstream_hours    := env_var_or_default('UPSTREAM_HOURS', '100')
dist_hours        := env_var_or_default('DIST_HOURS', '100')

# =============================================================================
# Tier 3: Derived paths (all computed from Tier 1 + 2)
# =============================================================================

path_repo                           := `git rev-parse --show-toplevel`
path_project                        := path_repo / "rate_design" / state / "hp_rates"
path_config                         := path_project / "config"
path_tariffs_electric               := path_config / "tariffs/electric"
path_tariffs_gas                    := path_config / "tariffs/gas"
path_scenarios                      := path_config / "scenarios"
path_scenario_config                := path_scenarios / "scenarios_" + utility + ".yaml"
path_periods_yaml                   := path_config / "periods" / utility + ".yaml"
path_rev_requirement                := path_config / "rev_requirement"
path_default_rev_requirement        := path_rev_requirement / utility + ".yaml"
path_differentiated_rev_requirement := path_rev_requirement / utility + "_hp_vs_nonhp.yaml"
path_revenue_csv                    := "s3://data.sb/switchbox/revenue_requirements/" + state + "/revenue_requirements_dummy.csv"
revenue_utility_col                 := "utility"
revenue_year_col                    := "year"
path_tariff_maps                    := path_config / "tariff_maps"
# TODO: replace cenhud placeholder with per-utility MC data once generated
path_td_mc                          := "s3://data.sb/switchbox/marginal_costs/" + state + "/region=" + region + "/utility=cenhud/year=" + mc_year + "/00000000.parquet"
path_resstock_base                  := "s3://data.sb/nrel/resstock/res_2024_amy2018_2/"
path_s3_resstock_metadata           := "s3://data.sb/nrel/resstock/res_2024_amy2018_2/metadata"
path_s3_utility_assignment          := "s3://data.sb/nrel/resstock/res_2024_amy2018_2/metadata_utility"
path_resstock_loads_00              := path_resstock_base + "/load_curve_hourly/state=" + state_upper + "/upgrade=" + upgrade
# TODO: replace RI placeholder with correct NY Cambium BA once confirmed
path_cambium                        := "s3://data.sb/nrel/cambium/2024/scenario=MidCase/t=2025/gea=ISONE/r=p133/data.parquet"
path_mc_table                       := env_var_or_default('MC_TABLE', path_config / "marginal_costs" / "ny_marginal_costs_2026_2035.csv")
path_s3_mc_output                   := "s3://data.sb/switchbox/marginal_costs/" + state + "/"
path_s3_utility_loads               := "s3://data.sb/eia/hourly_demand/utilities/"
path_electric_utility_stats         := "s3://data.sb/eia/861/electric_utility_stats/year=2024/state=" + state_upper + "/data.parquet"
path_default_tariff                 := path_tariffs_electric / default_tariff
path_default_supply_tariff          := path_tariffs_electric / default_tariff_supply
tou_tariff_key                      := utility + "_hp_seasonalTOU"
latest_output                       := path_repo / "utils/mid/latest_run_output.sh"

# =============================================================================
# VALIDATION
# =============================================================================

validate-config mode="warn":
  uv run python {{path_repo}}/utils/pre/validate_config.py \
    --scenario-config "{{path_scenario_config}}" \
    --state "{{state_upper}}" \
    --utility "{{utility}}" \
    --upgrade "{{upgrade}}" \
    --year "{{year}}" \
    --path-td-mc "{{path_td_mc}}" \
    --path-cambium "{{path_cambium}}" \
    --path-electric-utility-stats "{{path_electric_utility_stats}}" \
    --path-resstock-loads "{{path_resstock_loads_00}}" \
    {{ if mode == "strict" { "--strict" } else { "" } }}

# =============================================================================
# PRE-CONFIG: generate before any runs
# =============================================================================

create-scenario-yamls:
    just -f {{path_repo}}/utils/Justfile create-scenario-yamls

create-electric-tariff-maps-all:
    just -f {{path_repo}}/utils/Justfile write-tariff-maps-all "{{path_scenarios}}"

create-revenue-yaml:
  uv run python {{path_repo}}/utils/pre/create_revenue_yaml.py \
    --path-revenue-csv "{{path_revenue_csv}}" \
    --path-output-yaml "{{path_default_rev_requirement}}" \
    --utility "{{utility}}" \
    --year "{{year}}" \
    --utility-col "{{revenue_utility_col}}" \
    --year-col "{{revenue_year_col}}"

create-flat-tariff:
  just -f {{path_repo}}/utils/Justfile create-flat-tariff \
    "{{path_default_tariff}}" \
    "{{path_default_supply_tariff}}" \
    "{{utility}}_flat" \
    "{{utility}}_flat_supply" \
    "{{path_tariffs_electric}}"

create-seasonal-tou key=tou_tariff_key reference_tariff="":
  just -f {{path_repo}}/utils/Justfile create-seasonal-tou \
    "{{path_cambium}}" \
    "{{state_upper}}" \
    "{{utility}}" \
    "{{year}}" \
    "{{path_td_mc}}" \
    "{{path_resstock_base}}/metadata/state={{state_upper}}/upgrade={{upgrade}}/metadata-sb.parquet" \
    "{{path_resstock_base}}" \
    "{{upgrade}}" \
    "{{path_electric_utility_stats}}" \
    "{{key}}" \
    "{{path_config}}" \
    "{{path_periods_yaml}}" \
    "{{reference_tariff}}"

create-gas-tariff-map electric_utility upgrade_id output_dir:
  just -f {{path_repo}}/utils/Justfile create-gas-tariff-map \
    "{{path_s3_resstock_metadata}}" \
    "{{path_s3_utility_assignment}}" \
    "{{state_upper}}" \
    "{{electric_utility}}" \
    "{{upgrade_id}}" \
    "{{output_dir}}"

create-gas-tariff-maps-all:
  just create-gas-tariff-map {{utility}} {{upgrade}} {{path_tariff_maps}}/gas

create-td-mc-data:
  uv run python {{path_repo}}/utils/pre/generate_utility_tx_dx_mc.py \
    --state {{state_upper}} \
    --utility {{utility}} \
    --mc-year {{mc_year}} \
    --load-year {{year}} \
    --mc-table-path {{path_mc_table}} \
    --utility-load-s3-base {{path_s3_utility_loads}} \
    --output-s3-base {{path_s3_mc_output}} \
    --upstream-hours {{upstream_hours}} \
    --dist-hours {{dist_hours}} \
    --upload

create-td-mc-data-all:
  just create-td-mc-data nyseg
  just create-td-mc-data rge
  just create-td-mc-data cenhud

# =============================================================================
# MID-CONFIG: generate between runs (using outputs from earlier runs)
# =============================================================================

compute-subclass-rr run_dir scenario_config run_num="1" group_col="has_hp" cross_subsidy_col="BAT_percustomer" differentiated_yaml=path_differentiated_rev_requirement default_yaml=path_default_rev_requirement:
  just -f {{path_repo}}/utils/Justfile compute-subclass-rr \
    "{{run_dir}}" \
    "{{scenario_config}}" \
    "{{differentiated_yaml}}" \
    "{{default_yaml}}" \
    "{{run_num}}" \
    "{{group_col}}" \
    "{{cross_subsidy_col}}"

compute-seasonal-discount-inputs run_dir resstock_base state upgrade cross_subsidy_col="BAT_percustomer" output_dir="":
  just -f {{path_repo}}/utils/Justfile compute-seasonal-discount-inputs \
    "{{run_dir}}" \
    "{{resstock_base}}" \
    "{{state_upper}}" \
    "{{upgrade}}" \
    "{{cross_subsidy_col}}" \
    "{{output_dir}}"

create-seasonal-discount-tariff base_tariff_json seasonal_inputs_csv label output_path periods_yaml=path_periods_yaml:
  just -f {{path_repo}}/utils/Justfile create-seasonal-discount-tariff \
    "{{base_tariff_json}}" \
    "{{seasonal_inputs_csv}}" \
    "{{label}}" \
    "{{output_path}}" \
    "{{periods_yaml}}"

copy-calibrated-tariff-from-run run_dir output_dir="":
  just -f {{path_repo}}/utils/Justfile copy-calibrated-tariff-from-run \
    "{{run_dir}}" \
    "{{state}}" \
    "{{output_dir}}"

compute-rev-requirements:
    #!/usr/bin/env bash
    set -euo pipefail
    run1_dir=$(bash "{{latest_output}}" "{{path_scenario_config}}" 1)
    echo ">> compute-rev-requirements: resolved run-1 output → ${run1_dir}" >&2
    just compute-subclass-rr "${run1_dir}" "{{path_scenario_config}}"

# =============================================================================
# RUNS: scenario execution (run-1 through run-12)
# =============================================================================

run-scenario run_num:
  uv run python {{path_project}}/run_scenario.py \
    --run-num "{{run_num}}" \
    --utility "{{utility}}"

# Run 1: precalc flat, delivery
run-1:
    just create-flat-tariff
    just run-scenario 1

# Run 2: precalc flat, supply (flat_supply.json exists from run-1 PRE)
run-2:
    just run-scenario 2

# Run 3: default flat calibrated, delivery (needs run 1 output)
run-3:
    #!/usr/bin/env bash
    set -euo pipefail
    run1_dir=$(bash "{{latest_output}}" "{{path_scenario_config}}" 1)
    echo ">> run-3: resolved run-1 output → ${run1_dir}" >&2
    just copy-calibrated-tariff-from-run "${run1_dir}"
    just run-scenario 3

# Run 4: default flat calibrated, supply (needs run 2 output)
run-4:
    #!/usr/bin/env bash
    set -euo pipefail
    run2_dir=$(bash "{{latest_output}}" "{{path_scenario_config}}" 2)
    echo ">> run-4: resolved run-2 output → ${run2_dir}" >&2
    just copy-calibrated-tariff-from-run "${run2_dir}"
    just run-scenario 4

# Run 5: precalc hp_seasonal vs flat, delivery
run-5:
    #!/usr/bin/env bash
    set -euo pipefail
    run1_dir=$(bash "{{latest_output}}" "{{path_scenario_config}}" 1)
    echo ">> run-5: resolved run-1 output → ${run1_dir}" >&2
    just compute-seasonal-discount-inputs "${run1_dir}" "{{path_resstock_base}}" "{{state_upper}}" "{{upgrade}}"
    just create-seasonal-discount-tariff \
        "{{path_tariffs_electric}}/{{utility}}_flat_calibrated.json" \
        "${run1_dir}seasonal_discount_rate_inputs.csv" \
        {{utility}}_hp_seasonal \
        "{{path_tariffs_electric}}/{{utility}}_hp_seasonal.json"
    just run-scenario 5

# Run 6: precalc hp_seasonal vs flat, supply
run-6:
    #!/usr/bin/env bash
    set -euo pipefail
    run2_dir=$(bash "{{latest_output}}" "{{path_scenario_config}}" 2)
    echo ">> run-6: resolved run-2 output → ${run2_dir}" >&2
    just compute-seasonal-discount-inputs "${run2_dir}" "{{path_resstock_base}}" "{{state_upper}}" "{{upgrade}}"
    just create-seasonal-discount-tariff \
        "{{path_tariffs_electric}}/{{utility}}_flat_supply_calibrated.json" \
        "${run2_dir}seasonal_discount_rate_inputs.csv" \
        {{utility}}_hp_seasonal_supply \
        "{{path_tariffs_electric}}/{{utility}}_hp_seasonal_supply.json"
    just run-scenario 6

# Run 7: default hp_seasonal calibrated, delivery (needs run 5 output)
run-7:
    #!/usr/bin/env bash
    set -euo pipefail
    run5_dir=$(bash "{{latest_output}}" "{{path_scenario_config}}" 5)
    echo ">> run-7: resolved run-5 output → ${run5_dir}" >&2
    just copy-calibrated-tariff-from-run "${run5_dir}"
    just run-scenario 7

# Run 8: default hp_seasonal calibrated, supply (needs run 6 output)
run-8:
    #!/usr/bin/env bash
    set -euo pipefail
    run6_dir=$(bash "{{latest_output}}" "{{path_scenario_config}}" 6)
    echo ">> run-8: resolved run-6 output → ${run6_dir}" >&2
    just copy-calibrated-tariff-from-run "${run6_dir}"
    just run-scenario 8

# Run 9: precalc hp_seasonalTOU vs flat, delivery
run-9:
    #!/usr/bin/env bash
    set -euo pipefail
    ref_tariff="{{path_tariffs_electric}}/{{utility}}_flat_calibrated.json"
    if [ ! -f "${ref_tariff}" ]; then
        run1_dir=$(bash "{{latest_output}}" "{{path_scenario_config}}" 1)
        echo ">> run-9: calibrated tariff missing, copying from run-1 → ${run1_dir}" >&2
        just copy-calibrated-tariff-from-run "${run1_dir}"
    fi
    just create-seasonal-tou {{tou_tariff_key}} "${ref_tariff}"
    just run-scenario 9

# Run 10: precalc hp_seasonalTOU vs flat, supply
run-10:
    #!/usr/bin/env bash
    set -euo pipefail
    ref_tariff="{{path_tariffs_electric}}/{{utility}}_flat_supply_calibrated.json"
    if [ ! -f "${ref_tariff}" ]; then
        run2_dir=$(bash "{{latest_output}}" "{{path_scenario_config}}" 2)
        echo ">> run-10: calibrated supply tariff missing, copying from run-2 → ${run2_dir}" >&2
        just copy-calibrated-tariff-from-run "${run2_dir}"
    fi
    just create-seasonal-tou {{tou_tariff_key}}_supply "${ref_tariff}"
    just run-scenario 10

# Run 11: default hp_seasonalTOU calibrated, delivery (needs run 9 output)
run-11:
    #!/usr/bin/env bash
    set -euo pipefail
    run9_dir=$(bash "{{latest_output}}" "{{path_scenario_config}}" 9)
    echo ">> run-11: resolved run-9 output → ${run9_dir}" >&2
    just copy-calibrated-tariff-from-run "${run9_dir}"
    just run-scenario 11

# Run 12: default hp_seasonalTOU calibrated, supply (needs run 10 output)
run-12:
    #!/usr/bin/env bash
    set -euo pipefail
    run10_dir=$(bash "{{latest_output}}" "{{path_scenario_config}}" 10)
    echo ">> run-12: resolved run-10 output → ${run10_dir}" >&2
    just copy-calibrated-tariff-from-run "${run10_dir}"
    just run-scenario 12

# =============================================================================
# MASTER: orchestration entrypoints
# =============================================================================

all-pre:
    just create-scenario-yamls
    just create-electric-tariff-maps-all
    just create-revenue-yaml
    just validate-config

run-all-sequential:
    just run-1
    just compute-rev-requirements
    just run-2
    just run-3
    just run-4
    just run-5
    just run-6
    just run-7
    just run-8
    just run-9
    just run-10
    just run-11
    just run-12

# Run all 7 utilities sequentially.
run-all-utilities-sequential:
    #!/usr/bin/env bash
    set -euo pipefail
    for util in coned nimo nyseg cenhud or psegli rge; do
        echo ">> ======================================" >&2
        echo ">> Running utility: $util" >&2
        echo ">> ======================================" >&2
        UTILITY="$util" just all-pre
        UTILITY="$util" just run-all-sequential
    done

# Parallel multi-utility execution is not yet implemented. Each utility's
# outputs are utility-namespaced (config/tariffs/electric/<utility>_*.json,
# S3 output dirs include utility name), so parallel should be safe -- but
# needs testing before enabling.

# =============================================================================
# DATA PREP: tariff mapping, polygon downloads, marginal costs
# (separate concern from run orchestration; run before all-pre)
# =============================================================================

# --- Electric tariff mapping ---

map-electric-tariff electric_utility SB_scenario_type SB_scenario_year upgrade_id output_dir:
  uv run python {{path_repo}}/utils/pre/electric_tariff_mapper.py \
    --metadata_path "{{path_s3_resstock_metadata}}" \
    --state {{state_upper}} \
    --upgrade_id "{{upgrade_id}}" \
    --electric_utility "{{electric_utility}}" \
    --SB_scenario_type "{{SB_scenario_type}}" \
    --SB_scenario_year "{{SB_scenario_year}}" \
    --output_dir "{{output_dir}}"

map-electric-coned-default:
  just map-electric-tariff coned default 1 00 {{path_tariff_maps}}/electric

map-electric-coned-seasonal:
  just map-electric-tariff coned seasonal 1 00 {{path_tariff_maps}}/electric

map-electric-coned-class-specific-seasonal:
  just map-electric-tariff coned class_specific_seasonal 1 00 {{path_tariff_maps}}/electric

map-electric-national-grid-default:
  just map-electric-tariff nimo default 1 00 {{path_tariff_maps}}/electric

map-electric-national-grid-seasonal:
  just map-electric-tariff nimo seasonal 1 00 {{path_tariff_maps}}/electric

map-electric-national-grid-class-specific-seasonal:
  just map-electric-tariff nimo class_specific_seasonal 1 00 {{path_tariff_maps}}/electric

map-electric-nyseg-default:
  just map-electric-tariff nyseg default 1 00 {{path_tariff_maps}}/electric

map-electric-nyseg-seasonal:
  just map-electric-tariff nyseg seasonal 1 00 {{path_tariff_maps}}/electric

map-electric-nyseg-class-specific-seasonal:
  just map-electric-tariff nyseg class_specific_seasonal 1 00 {{path_tariff_maps}}/electric

# --- Gas tariff mapping ---

map-gas-tariff electric_utility upgrade_id output_dir:
  just create-gas-tariff-map "{{electric_utility}}" "{{upgrade_id}}" "{{output_dir}}"

map-gas-bath:
  just map-gas-tariff bath 00 {{path_tariff_maps}}/gas

map-gas-cenhud:
  just map-gas-tariff cenhud 00 {{path_tariff_maps}}/gas

map-gas-chautauqua:
  just map-gas-tariff chautauqua 00 {{path_tariff_maps}}/gas

map-gas-coned:
  just map-gas-tariff coned 00 {{path_tariff_maps}}/gas

map-gas-national-grid:
  just map-gas-tariff nimo 00 {{path_tariff_maps}}/gas

map-gas-nyseg:
  just map-gas-tariff nyseg 00 {{path_tariff_maps}}/gas

map-gas-or:
  just map-gas-tariff or 00 {{path_tariff_maps}}/gas

map-gas-psegli:
  just map-gas-tariff psegli 00 {{path_tariff_maps}}/gas

map-gas-rge:
  just map-gas-tariff rge 00 {{path_tariff_maps}}/gas

map-gas-all-utilities:
  just map-gas-bath
  just map-gas-cenhud
  just map-gas-chautauqua
  just map-gas-coned
  just map-gas-national-grid
  just map-gas-nyseg
  just map-gas-or
  just map-gas-psegli
  just map-gas-rge

# --- NY polygon downloads ---

download-ny-utility-polygons:
	just download-ny-electric-utility-polygons
	just download-ny-gas-utility-polygons

download-ny-electric-utility-polygons:
	wget -qO- --user-agent="Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:89.0) Gecko/20100101 Firefox/89.0" "https://data.ny.gov/resource/awza-4vgu.csv" | aws s3 cp - "s3://data.sb/gis/utility_boundaries/ny_electric_utilities_`date +%Y%m%d`.csv"
	just test-ny-electric-utility-polygons-download

download-ny-gas-utility-polygons:
	wget -qO- --user-agent="Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:89.0) Gecko/20100101 Firefox/89.0" "https://data.ny.gov/api/views/i7nm-ih89/rows.csv" | aws s3 cp - "s3://data.sb/gis/utility_boundaries/ny_gas_utilities_$(date +%Y%m%d).csv"
	just test-ny-gas-utility-polygons-download

test-ny-electric-utility-polygons-download:
	aws s3 ls "s3://data.sb/gis/utility_boundaries/" | grep "ny_electric_utilities_.*\.csv"

test-ny-gas-utility-polygons-download:
	aws s3 ls "s3://data.sb/gis/utility_boundaries/" | grep "ny_gas_utilities_.*\.csv"

# =============================================================================
# POST: after all runs are completed
# =============================================================================

apply-ny-lmi-discounts run_dir utility fpl_year cpi_s3_path participation_rate="1.0" rider="false":
  uv run python {{path_repo}}/utils/post/apply_ny_lmi_discounts_to_bills.py \
    --run-dir "{{run_dir}}" \
    --state {{state_upper}} \
    --utility {{utility}} \
    --fpl-year {{fpl_year}} \
    --cpi-s3-path "{{cpi_s3_path}}" \
    --participation-rate {{participation_rate}} \
    {{ if rider == "true" { "--rider" } else { "" } }} \
    --upload

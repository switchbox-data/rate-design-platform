---
title: "First-Pass TOU Scheduling Decision Model for HPWHs in OCHRE"
author: "NREL/OCHRE Team"
date: "`r Sys.Date()`"
format: gfm
---

# Introduction

This document outlines a simple, first-pass heuristic-based decision model for consumer response to time-of-use (TOU) electricity rates in residential building simulations using OCHRE, focusing on Heat Pump Water Heaters (HPWHs). The goal is to integrate an adaptive control schedule for the HPWH based on feedback from utility bills and anticipated cost savings, while accounting for consumer effort in shifting schedules.

# 1. Problem Definition
This section establishes a high-level overview of the core research question and modeling assumptions for consumer response to TOU rates.
- **Objective:** Model how a consumer, with fixed (exogenous) hot water usage needs, might reschedule their HPWH operation in response to TOU rates to minimize their electricity bills, considering a "switching cost" for effort/comfort.
- **Assumptions:**
    - Hot water usage schedule is fixed (not flexible) and set by inputs to the model.
    - HPWH can be controlled (on/off) on a schedule.
    - TOU rate structure (on-peak/off-peak) is known and simple (e.g., higher price during peak hours), such that the consumer can reasonably set a schedule to turn on HPWH during off-peak hours.
    - Consumer receives feedback on energy cost and makes switching decisions at bill receipt each billing cycle (monthly) rather than at each operational time step (every 15 minutes).
    - Switching to a TOU-adapted schedule incurs a one-time "effort cost" (can be fixed or parameterized).
    - Decision process is repeated each billing cycle (feedback loop), with the decision model output feeding into the next iteration of the simulation.

# 2. Key Variables and Parameters
This section defines all variables, parameters, and their temporal dimensions used throughout the decision model.

| Symbol         | Type | Description                                           | Units    | Dimension |
|----------------|------|-------------------------------------------------------|----------|-----------|
| **Sets** |
| \( T \)        | Set  | Time periods in billing month, \( t \in \{1, 2, ..., T\} \) where \( T = 2976 \) (15-min intervals) | -        | 2976 × 1  |
| \( H \)        | Set  | Peak hour periods, \( H \subset T \)                 | -        | \|H\| × 1 |
| **Parameters** |
| \( U_t^{HW} \) | Parameter | Exogenous hot water usage schedule at time \( t \) | L/15min  | T × 1     |
| \( r^{on} \)   | Parameter | TOU electricity rate during peak hours              | $/kWh    | 1 × 1     |
| \( r^{off} \)  | Parameter | TOU electricity rate during off-peak hours          | $/kWh    | 1 × 1     |
| \( C^{switch} \) | Parameter | Consumer switching/"hassle" cost per schedule change | $        | 1 × 1     |
| \( \alpha \)   | Parameter | Monetization factor for comfort penalty              | $/kWh    | 1 × 1     |
| **Decision Variables** |
| \( x^{switch} \) | Binary | Decision to switch schedule next month (1 = switch, 0 = stay) | binary | 1 × 1 |
| **State Variables** |
| \( S^{current} \) | Binary | Current schedule state (1 = default, 0 = TOU-adapted) | binary | 1 × 1 |
| \( s_t \)      | Binary | HPWH operation permission at time \( t \) (1 = allowed, 0 = restricted) | binary | T × 1 |
| \( E_t \)      | Variable | Electricity consumption from HPWH operation at time \( t \) | kWh/15min | T × 1 |
| \( D_t^{unmet} \) | Variable | Unmet hot water demand at time \( t \)           | kWh/15min | T × 1 |
| **Derived (Output)Variables** |
| \( C^{bill} \) | Variable | Monthly electricity bill for water heating           | $        | 1 × 1     |
| \( C^{comfort} \) | Variable | Monthly comfort penalty from unmet demand         | $        | 1 × 1     |
| \( \Delta C \) | Variable | Realized bill savings from TOU schedule vs. default | $        | 1 × 1     |

# 3. Model Steps
This section outlines the sequential decision-making process that consumers follow each month when receiving their utility bill. The framework distinguishes between two decision contexts: initial adoption decisions (based on anticipated savings) and continuation decisions (based on realized performance including comfort penalties). The monthly cycle creates a feedback loop between expectations and experience.
## Step 1: Calculate Baseline

- **Hot Water Usage:** \( U_t^{HW} \) is fixed exogenously for all \( t \in T \).
- **HPWH Default Schedule:** Set \( S^{current} = 1 \), which implies \( s_t = 1 \) for all \( t \in T \) (HP is turned on always, with basic thermostatic control loop to maintain a residence-specified setpoint).
- **Simulate:** Run OCHRE with default HPWH schedule to get \( E_t^{default} \) and calculate:
   \[
   C^{bill,default} = \sum_{t \in T} E_t^{default} \cdot r_t
   \]
   where \( r_t = r^{on} \) if \( t \in H \), else \( r_t = r^{off} \).

## Step 2: Define TOU-Adaptive Schedule

- **HPWH TOU Schedule:** Set \( S^{current} = 0 \), which implies:
   \[
   s_t = \begin{cases}
   0 & \text{if } t \in H \text{ (peak hours)} \\
   1 & \text{if } t \notin H \text{ (off-peak hours)}
   \end{cases}
   \]
- **Simulate:** Run OCHRE with TOU-adaptive HPWH schedule to get \( E_t^{TOU} \), \( D_t^{unmet} \) and calculate:
   \[
   C^{bill,TOU} = \sum_{t \in T} E_t^{TOU} \cdot r_t
   \]

## Step 3: Anticipated Savings (Initial Decision Only)

If consumer is currently on default schedule (\( S^{current} = 1 \)), calculate anticipated savings without comfort penalty knowledge:
- **Anticipated Bill Savings:**
   \[
   \Delta C^{anticipated} = C^{bill,default} - C^{bill,TOU}
   \]
- **Net Anticipated Benefit:**
   \[
   \text{Net Savings}^{anticipated} = \Delta C^{anticipated} - C^{switch}
   \]

## Step 4: Initial Decision Rule

- **If** \( \text{Net Savings}^{anticipated} > 0 \): Consumer switches to TOU-adapted schedule (\( x^{switch} = 1 \)).
- **Else:** Remains on default schedule (\( x^{switch} = 0 \)).

## Step 5: Realized Performance & Continuation Decision

For consumers currently on TOU schedule (\( S^{current} = 0 \)), evaluate continuation based on realized costs:
- **Comfort Penalty:**
   \[
   C^{comfort} = \alpha \cdot \sum_{t \in T} D_t^{unmet}
   \]
- **Realized Net Savings:**
   \[
   \text{Net Savings}^{realized} = \Delta C^{anticipated} - C^{switch} - C^{comfort}
   \]
- **Continuation Decision:** If \( \text{Net Savings}^{realized} \leq 0 \), switch back to default (\( x^{switch} = 1 \)).

## Step 6: Monthly Iteration

At each monthly billing cycle:
- Update \( S^{current} \) based on previous month's \( x^{switch} \)
- Apply Step 3-4 (anticipated decision) if \( S^{current} = 1 \)
- Apply Step 5 (continuation decision) if \( S^{current} = 0 \)
- Repeat process with updated consumption patterns and bills

# 4. Integration with OCHRE
This section specifies how the behavioral decision model interfaces with OCHRE's technical building simulation capabilities. It identifies the required inputs for consumer modeling, maps OCHRE's simulation outputs to monthly decision variables, and describes the implementation approach for dynamic schedule switching within the simulation framework.
## Inputs Required

- Hot water usage schedule: `HotWaterUsageSchedule`
- Usage multiplier: `UsageMultiplier`
- TOU rate definition: `r_{on}, r_{off}` (passed to cost calculation)
- HPWH scheduling control: ability to enforce on/off operation windows

## OCHRE Outputs Used

| Output Name                   | Use in Model                         |
|-------------------------------|--------------------------------------|
| Hot Water Delivered (L/min)   | For checking comfort/unmet demand    |
| Water Heating Delivered (W)   | For cost calculation                 |
| Hot Water Outlet Temperature  | For comfort check (optional)         |
| Hot Water Unmet Demand (kW)   | To quantify service/comfort loss     |

## Implementation Notes

- **Control:** Implement schedule-based control in OCHRE (see `update_external_control` in HPWH code).
- **Comfort Check:** If TOU schedule leads to unmet demand or low temp, can factor "comfort penalty" into switching cost.
- **Outputs:** Compare cost and comfort metrics for both schedules.

# 5. Example Calculation
This section provides a concrete numerical example demonstrating how the decision model operates for a representative consumer. The example is designed to illustrate the model's decision-making logic and the impact of key parameters on the consumer's choice.
Suppose:

- Default schedule: HPWH runs as needed.
- TOU schedule: HPWH only runs 10PM–6AM (off-peak).
- Monthly bill (default): $30
- Monthly bill (TOU): $22
- Switching cost: $5 (one-time or amortized)

\[
\Delta C = 30 - 22 = \$8
\]
\[
\text{Net Savings} = 8 - 5 = \$3
\]

**Decision:** Consumer switches to TOU-adaptive schedule.


# 7. Summary Table
This section provides a concise summary of the model's key steps and their integration with OCHRE. It serves as a quick reference for understanding how the decision model operates within the broader simulation framework.
| Step         | Action                                      | OCHRE Integration                        |
|--------------|---------------------------------------------|------------------------------------------|
| 1            | Simulate default schedule                   | Run with normal HPWH control             |
| 2            | Simulate TOU-adaptive schedule              | Run with off-peak-restricted HPWH        |
| 3            | Compare bills and comfort                   | Use OCHRE output variables above         |
| 4            | Decision to switch?                         | Apply decision rule                      |
| 5            | Repeat monthly                              | Feedback loop                            |

# 8. References
This section lists references and resources for further information and context regarding the model and its implementation.
- [OCHRE Inputs and Arguments](https://github.com/NREL/OCHRE/blob/main/docs/source/InputsAndArguments.rst)
- [OCHRE Outputs](https://github.com/NREL/OCHRE/blob/main/docs/source/Outputs.rst)
- [OCHRE Water Model](https://github.com/NREL/OCHRE/blob/main/ochre/Models/Water.py)
- [HPWH Control Logic](https://github.com/NREL/OCHRE/blob/main/ochre/Equipment/WaterHeater.py)
